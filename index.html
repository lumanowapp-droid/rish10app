<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rishaan's 10th Birthday - Food Order</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<style>
/* ============================================
   ULTRA PREMIUM DARK THEME
   ============================================ */
:root {
  --bg-primary: #030305;
  --bg-secondary: #08080e;
  --bg-card: #0c0c14;
  --bg-elevated: #101018;
  --gold: #ffd700;
  --gold-dim: #b8860b;
  --gold-light: #ffe55c;
  --red: #ff4757;
  --green: #10b981;
  --purple: #a78bfa;
  --pink: #ec4899;
  --blue: #60a5fa;
  --text: #eaeaf0;
  --text-muted: #6a6a7a;
  --text-subtle: #4a4a5a;
  --border: rgba(255,215,0,0.12);
  --border-bright: rgba(255,215,0,0.3);
  --glow-gold: rgba(255,215,0,0.15);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 80px;
  overflow-x: hidden;
}

/* Subtle vignette */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at 50% 0%, rgba(255,215,0,0.03) 0%, transparent 60%),
              radial-gradient(ellipse at 50% 100%, rgba(0,0,0,0.5) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* ============================================ HEADER */
.header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-bright);
  padding: 14px 20px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: 0 4px 30px rgba(0,0,0,0.9);
}
.header-logo { display: flex; align-items: center; justify-content: center; gap: 10px; }
.shield { width: 34px; height: 34px; }
.header h1 {
  font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 800;
  background: linear-gradient(135deg, var(--gold), #fff, var(--gold)); background-size: 200% 100%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  letter-spacing: 2px; text-transform: uppercase; animation: shimmer 3s ease-in-out infinite;
}
.header p { font-size: 0.72rem; color: var(--text-muted); letter-spacing: 1px; font-weight: 500; margin-top: 2px; }
.rpm-bar { height: 2px; margin-top: 10px; background: linear-gradient(90deg, transparent, var(--gold), var(--red), var(--gold), transparent); border-radius: 2px; animation: rpmPulse 2s ease-in-out infinite; }

/* ============================================ BOTTOM NAV */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-bright); display: flex; z-index: 50; box-shadow: 0 -4px 30px rgba(0,0,0,0.9); }
.bottom-nav button { flex: 1; padding: 10px 0 8px; border: none; background: none; font-family: 'Rajdhani', sans-serif; font-size: 0.68rem; font-weight: 600; color: var(--text-subtle); display: flex; flex-direction: column; align-items: center; gap: 3px; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; position: relative; transition: color 0.2s; }
.bottom-nav button.active { color: var(--gold); }
.bottom-nav button.active::after { content: ''; position: absolute; top: 0; left: 25%; right: 25%; height: 2px; background: var(--gold); }
.bottom-nav button i { font-size: 1.15rem; }

/* ============================================ TABS */
.tab-content { display: none; padding: 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
.tab-content.active { display: block; }

/* ============================================ CARDS */
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; margin-bottom: 14px; position: relative; overflow: hidden; }
.card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
.card-title { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.85rem; color: var(--gold); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; letter-spacing: 1.5px; text-transform: uppercase; }

/* ============================================ CAR BANNER */
.car-banner { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; margin-bottom: 14px; text-align: center; }
.car-emoji-row { display: flex; justify-content: center; gap: 12px; font-size: 2rem; margin-bottom: 6px; }
.speed-text { font-family: 'Orbitron', sans-serif; font-size: 0.6rem; color: var(--gold); letter-spacing: 3px; text-transform: uppercase; opacity: 0.6; }

/* ============================================ KID CHIPS */
.kid-chip { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 50px; font-size: 1rem; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.08); background: var(--bg-elevated); color: var(--text-muted); margin: 3px; letter-spacing: 0.5px; transition: all 0.15s; user-select: none; -webkit-user-select: none; }
.kid-chip.selected { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #000; border-color: var(--gold); box-shadow: 0 2px 12px rgba(255,215,0,0.3); }
.kid-chip .remove { font-size: 0.65rem; opacity: 0.7; cursor: pointer; }

/* ============================================ MENU ITEMS */
.menu-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; margin-bottom: 6px; background: var(--bg-elevated); gap: 8px; }
.menu-item.has-qty { border-color: rgba(255,215,0,0.2); background: rgba(255,215,0,0.03); }
.menu-item.disabled { opacity: 0.2; pointer-events: none; }
.item-name { font-weight: 700; font-size: 1rem; color: var(--text); display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
.item-name .name-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ============================================ QTY BADGE */
.qty-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; border-radius: 50%; font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 900; flex-shrink: 0; border: 2px solid; }
.qty-badge.has-qty { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: #000; border-color: var(--gold-light); box-shadow: 0 2px 12px rgba(255,215,0,0.4); }
.qty-badge.no-qty { background: var(--bg-secondary); color: var(--text-subtle); border-color: rgba(255,255,255,0.06); }

/* ============================================ QTY CONTROLS */
.qty-control { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.qty-btn {
  width: 44px; height: 44px; border: none; border-radius: 12px;
  font-size: 1.5rem; font-weight: 900; line-height: 1;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  padding: 0; margin: 0; outline: none;
  -webkit-appearance: none; appearance: none;
  user-select: none; -webkit-user-select: none;
  touch-action: manipulation;
  position: relative; z-index: 5;
  transition: transform 0.1s, opacity 0.1s;
}
.qty-btn:active { transform: scale(0.9); }
.qty-btn.minus-btn { background: #dc2626; color: #fff; box-shadow: 0 2px 8px rgba(220,38,38,0.4); }
.qty-btn.plus-btn { background: var(--gold); color: #000; box-shadow: 0 2px 8px rgba(255,215,0,0.4); }
.qty-btn.dim { opacity: 0.25; }

.qty-input { width: 48px; height: 40px; background: #1a1a28; border: 2px solid rgba(255,215,0,0.25); border-radius: 8px; color: var(--gold-light); font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 900; text-align: center; outline: none; -moz-appearance: textfield; appearance: textfield; }
.qty-input::-webkit-inner-spin-button, .qty-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.qty-input:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(255,215,0,0.2); }

/* ============================================ CATEGORY */
.category-header { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.8rem; color: var(--gold); padding: 8px 0; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 8px; letter-spacing: 1.5px; text-transform: uppercase; }
.restriction-tag { font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; background: rgba(255,71,87,0.12); color: var(--red); padding: 2px 10px; border-radius: 50px; font-weight: 700; border: 1px solid rgba(255,71,87,0.2); }

/* ============================================ BADGES */
.badge { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #000; font-family: 'Orbitron', sans-serif; font-size: 0.5rem; padding: 2px 8px; border-radius: 50px; font-weight: 700; }
.badge-red { background: linear-gradient(135deg, var(--red), #c53050); color: white; }
.badge-green { background: linear-gradient(135deg, var(--green), #059669); color: white; }
.joint-badge { font-size: 0.6rem; background: var(--red); color: white; padding: 1px 7px; border-radius: 50px; margin-left: 4px; font-weight: 700; }

/* ============================================ BUTTONS */
.btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; letter-spacing: 0.5px; text-transform: uppercase; transition: opacity 0.15s; }
.btn:active { opacity: 0.8; }
.btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #000; }
.btn-red { background: var(--red); color: white; }
.btn-green { background: var(--green); color: white; }
.btn-sm { padding: 6px 14px; font-size: 0.85rem; border-radius: 8px; }
.btn-danger { background: rgba(255,71,87,0.12); color: var(--red); border: 1px solid rgba(255,71,87,0.2); }

/* ============================================ INPUTS */
.input, .select { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px; font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; font-weight: 500; outline: none; background: var(--bg-elevated); color: var(--text); transition: border-color 0.2s; }
.input:focus, .select:focus { border-color: var(--gold); box-shadow: 0 0 0 2px var(--glow-gold); }
.input::placeholder { color: var(--text-subtle); }

/* ============================================ ORDER ROWS */
.order-kid-name { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.85rem; color: var(--gold); padding: 8px 0; display: flex; align-items: center; gap: 8px; letter-spacing: 1px; }
.order-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.03); font-weight: 500; }
.summary-row { display: flex; justify-content: space-between; padding: 8px 14px; font-size: 1rem; font-weight: 600; }
.summary-row.total { font-family: 'Orbitron', sans-serif; font-weight: 800; border-top: 2px solid var(--gold); color: var(--gold); margin-top: 6px; padding-top: 12px; font-size: 0.85rem; }

/* ============================================ STAT BOXES */
.stat-box { border-radius: 12px; padding: 14px; text-align: center; border: 1px solid; background: var(--bg-elevated); }
.stat-num { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 900; }
.stat-label { font-size: 0.65rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

/* ============================================ TOGGLE */
.toggle { width: 44px; height: 24px; border-radius: 12px; background: rgba(255,255,255,0.08); position: relative; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: background 0.2s; flex-shrink: 0; }
.toggle.on { background: var(--gold); border-color: var(--gold); }
.toggle .knob { width: 20px; height: 20px; background: #ccc; border-radius: 50%; position: absolute; top: 1px; left: 1px; transition: left 0.2s; }
.toggle.on .knob { left: 21px; background: #111; }

/* ============================================ EMPTY STATE */
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); background: var(--bg-elevated); border-radius: 14px; border: 1px solid var(--border); }
.empty-state i { font-size: 2.5rem; margin-bottom: 12px; display: block; color: rgba(255,215,0,0.3); }
.empty-state p { font-size: 0.85rem; font-weight: 500; }

/* ============================================ EXPORT / MODAL */
.export-area { white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; padding: 14px; max-height: 400px; overflow-y: auto; line-height: 1.6; color: var(--gold-light); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 60; display: flex; align-items: flex-end; justify-content: center; }
.modal { background: var(--bg-card); border-radius: 20px 20px 0 0; border: 1px solid var(--border-bright); border-bottom: none; padding: 24px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto; animation: slideUp 0.25s ease; }

/* ============================================ HELPERS & ANIMATIONS */
.flex-wrap-gap { display: flex; flex-wrap: wrap; gap: 4px; }

@keyframes shimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes rpmPulse { 0%, 100% { opacity: 0.3; transform: scaleX(0.6); } 50% { opacity: 1; transform: scaleX(1); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes bounceIn { 0% { transform: translateX(-50%) scale(0.3); opacity: 0; } 50% { transform: translateX(-50%) scale(1.05); } 100% { transform: translateX(-50%) scale(1); opacity: 1; } }
.confetti { position: fixed; top: -10px; animation: fall linear forwards; pointer-events: none; z-index: 100; font-size: 1.5rem; }
@keyframes fall { to { top: 110vh; transform: rotate(720deg); } }
.koenigsegg-car { position: fixed; z-index: 1; pointer-events: none; }
@keyframes raceAcross { 0% { left: -80px; } 100% { left: 110vw; } }
@keyframes raceReverse { 0% { right: -80px; } 100% { right: 110vw; } }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 4px; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-logo">
    <svg class="shield" viewBox="0 0 80 90" fill="none">
      <path d="M40 5 L70 20 L70 60 Q70 75 40 85 Q10 75 10 60 L10 20Z" stroke="url(#hg)" stroke-width="2.5" fill="rgba(255,215,0,0.06)"/>
      <path d="M40 15 L30 35 L40 30 L50 35Z" fill="url(#hg)"/>
      <path d="M40 30 L25 40 L40 65 L55 40Z" fill="url(#hg)" opacity="0.8"/>
      <path d="M30 18 L35 12 L40 15 L45 12 L50 18" stroke="url(#hg)" stroke-width="1.5" fill="none"/>
      <defs><linearGradient id="hg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ffe55c"/></linearGradient></defs>
    </svg>
    <div>
      <h1>Rishaan's 10th</h1>
      <p><i class="fas fa-flag-checkered"></i> 13 Feb 2026 &bull; Birthday Pit Stop <i class="fas fa-flag-checkered"></i></p>
    </div>
    <svg class="shield" viewBox="0 0 80 90" fill="none" style="transform:scaleX(-1)">
      <path d="M40 5 L70 20 L70 60 Q70 75 40 85 Q10 75 10 60 L10 20Z" stroke="#ffd700" stroke-width="2.5" fill="rgba(255,215,0,0.06)"/>
      <path d="M40 15 L30 35 L40 30 L50 35Z" fill="#ffd700"/>
      <path d="M40 30 L25 40 L40 65 L55 40Z" fill="#ffd700" opacity="0.8"/>
      <path d="M30 18 L35 12 L40 15 L45 12 L50 18" stroke="#ffd700" stroke-width="1.5" fill="none"/>
    </svg>
  </div>
  <div class="rpm-bar"></div>
</div>

<!-- Message Overlay Bar -->
<div id="joke-banner" style="position:fixed;bottom:70px;left:0;right:0;z-index:100;background:linear-gradient(90deg,rgba(20,20,30,0.95),rgba(30,25,40,0.95),rgba(20,20,30,0.95));border-top:1px solid rgba(255,215,0,0.3);border-bottom:1px solid rgba(255,215,0,0.3);padding:10px 16px;display:none;box-shadow:0 -2px 20px rgba(0,0,0,0.8);backdrop-filter:blur(10px);transform:translateY(100%);transition:transform 0.4s ease;">
  <div style="font-family:'Rajdhani',sans-serif;font-size:0.75rem;font-weight:600;color:var(--gold);text-align:center;letter-spacing:0.8px;text-transform:uppercase;opacity:0.9;"><span id="joke-text"></span></div>
</div>

<!-- Sync Status -->
<div id="sync-status" style="position:fixed;top:80px;left:12px;z-index:100;background:var(--bg-card);border:1px solid rgba(16,185,129,0.3);border-radius:50px;padding:6px 14px;display:flex;align-items:center;gap:8px;">
  <div id="sync-dot" style="width:7px;height:7px;border-radius:50%;background:#10b981;box-shadow:0 0 6px #10b981;"></div>
  <div style="font-family:'Orbitron',sans-serif;font-size:0.55rem;color:#10b981;font-weight:700;">SYNCED</div>
</div>

<!-- Background Music Player -->
<button id="music-toggle" onclick="toggleMusic()" style="position:fixed;bottom:20px;right:20px;z-index:100;background:linear-gradient(135deg,var(--gold),var(--gold-dim));border:2px solid var(--gold-light);border-radius:50%;width:60px;height:60px;cursor:pointer;box-shadow:0 8px 32px rgba(255,215,0,0.5);display:flex;align-items:center;justify-content:center;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
  <i id="music-icon" class="fas fa-volume-up" style="font-size:1.5rem;color:#000;"></i>
</button>
<audio id="bg-music" loop preload="auto">
  <source src="https://cdn.freesound.org/previews/625/625671_7037-lq.mp3" type="audio/mpeg">
  <source src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" type="audio/mpeg">
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>


<!-- TAB: ORDER -->
<div id="tab-order" class="tab-content active">
  <div class="car-banner">
    <div class="car-emoji-row"><span>üèéÔ∏è</span><span>üèÅ</span><span>üèéÔ∏è</span></div>
    <div class="speed-text">Fueling up for an epic celebration</div>
  </div>
  <div class="card" id="batch-status-card"></div>
  <div class="card">
    <div class="card-title"><i class="fas fa-users"></i> Pit Crew - Who's Ordering?</div>
    <div id="kid-selector" class="flex-wrap-gap"></div>
    <div style="margin-top:8px;font-size:0.7rem;color:var(--text-subtle);font-weight:500;"><i class="fas fa-info-circle" style="color:var(--gold);"></i> Select multiple kids for a joint/shared order</div>
  </div>
  <div id="menu-area"></div>
</div>

<!-- TAB: DASHBOARD -->
<div id="tab-dashboard" class="tab-content">
  <div class="card"><div class="card-title"><i class="fas fa-gauge-high"></i> Race Dashboard</div><div id="dashboard-summary"></div></div>
  <div class="card"><div class="card-title"><i class="fas fa-helmet-safety"></i> Orders by Driver</div><div id="dashboard-by-kid"></div></div>
  <div class="card"><div class="card-title"><i class="fas fa-boxes-stacked"></i> Total Quantities</div><div id="dashboard-totals"></div></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
    <button class="btn btn-gold" onclick="exportOrder()"><i class="fas fa-file-export"></i> Export</button>
    <button class="btn btn-danger btn-sm" onclick="clearAllOrders()"><i class="fas fa-trash"></i> Clear All</button>
  </div>
</div>

<!-- TAB: GAMES -->
<div id="tab-games" class="tab-content">
  <div class="card">
    <div class="card-title"><i class="fas fa-plus-circle"></i> Add New Game</div>
    <input id="game-name-input" class="input" placeholder="Game name (e.g., Musical Chairs)" style="margin-bottom:8px;">
    <textarea id="game-instructions-input" class="input" placeholder="Instructions (optional)..." style="min-height:80px;resize:vertical;margin-bottom:8px;"></textarea>
    <button class="btn btn-gold" onclick="addGame()"><i class="fas fa-gamepad"></i> Create Game</button>
  </div>
  <div id="games-list"></div>
</div>

<!-- TAB: LEADERBOARD -->
<div id="tab-leaderboard" class="tab-content">
  <div class="card">
    <div class="card-title"><i class="fas fa-trophy"></i> Overall Rankings</div>
    <div id="overall-rankings"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-list-ol"></i> Game Results</div>
    <div id="game-breakdown"></div>
  </div>
</div>

<!-- TAB: SETTINGS -->
<div id="tab-settings" class="tab-content">
  <div class="card">
    <div class="card-title"><i class="fas fa-helmet-safety"></i> Drivers (Kids)</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;"><input id="kid-name-input" class="input" placeholder="Enter kid's name..."><button class="btn btn-gold btn-sm" onclick="addKid()"><i class="fas fa-plus"></i></button></div>
    <div id="kids-list" class="flex-wrap-gap"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-tags"></i> Categories</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;"><input id="cat-name-input" class="input" placeholder="Category (Pizza, Drinks...)"><button class="btn btn-gold btn-sm" onclick="addCategory()"><i class="fas fa-plus"></i></button></div>
    <div id="categories-list"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-utensils"></i> Menu Items</div>
    <div style="margin-bottom:10px;">
      <select id="item-cat-select" class="select" style="margin-bottom:8px;"><option value="">-- Select Category --</option></select>
      <div style="display:flex;gap:8px;"><input id="item-name-input" class="input" placeholder="Item name..."><button class="btn btn-gold btn-sm" onclick="addMenuItem()"><i class="fas fa-plus"></i></button></div>
    </div>
    <div id="menu-items-list"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-sliders"></i> Restrictions</div>
    <p style="font-size:0.75rem;color:var(--text-subtle);margin-bottom:12px;">Enable "Pick Only One" to limit each kid to one item from a category.</p>
    <div id="restrictions-list"></div>
  </div>
  <div class="card" style="border-color:rgba(16,185,129,0.15);">
    <div class="card-title" style="color:var(--green);"><i class="fas fa-shield-halved"></i> Data Backup</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-green btn-sm" onclick="downloadBackup()"><i class="fas fa-download"></i> Download</button>
      <button class="btn btn-gold btn-sm" onclick="document.getElementById('restore-input').click()"><i class="fas fa-upload"></i> Restore</button>
      <input type="file" id="restore-input" accept=".json" style="display:none" onchange="restoreBackup(event)">
    </div>
  </div>
  <div class="card" style="border-color:rgba(255,71,87,0.15);">
    <div class="card-title" style="color:var(--red);"><i class="fas fa-triangle-exclamation"></i> Danger Zone</div>
    <button class="btn btn-danger btn-sm" onclick="clearAllBatches()" style="width:100%;justify-content:center;margin-bottom:8px;"><i class="fas fa-trash"></i> Clear All Batches</button>
    <button class="btn btn-danger btn-sm" onclick="resetApp()" style="width:100%;justify-content:center;"><i class="fas fa-bomb"></i> Reset Entire App</button>
  </div>
</div>

<!-- TAB: DATA -->
<div id="tab-data" class="tab-content">
  <div class="card">
    <div class="card-title"><i class="fas fa-cloud"></i> Cloud Sync Setup</div>
    <div id="firebase-setup">
      <div style="background:rgba(255,215,0,0.03);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px;">
        <div style="font-size:0.72rem;font-weight:700;color:var(--gold);margin-bottom:8px;"><i class="fas fa-lightbulb"></i> Quick Setup</div>
        <ol style="font-size:0.72rem;color:var(--text-muted);line-height:1.6;padding-left:20px;">
          <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--gold);text-decoration:underline;">Firebase Console</a></li>
          <li>Create project ‚Üí Realtime Database ‚Üí test mode</li>
          <li>Project Settings ‚Üí Web app ‚Üí Copy config</li>
        </ol>
      </div>
      <label style="font-size:0.72rem;font-weight:600;color:var(--gold);display:block;margin-bottom:6px;">Paste Firebase Config JSON:</label>
      <textarea id="firebase-config-input" class="input" placeholder='{"apiKey":"...","databaseURL":"..."}' style="min-height:100px;font-family:monospace;font-size:0.68rem;resize:vertical;"></textarea>
      <button class="btn btn-gold" onclick="enableFirebaseSync()" style="width:100%;justify-content:center;margin-top:10px;"><i class="fas fa-rocket"></i> Enable Cloud Sync</button>
    </div>
    <div id="firebase-active" style="display:none;">
      <div style="background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:14px;text-align:center;">
        <i class="fas fa-check-circle" style="font-size:2rem;color:var(--green);margin-bottom:8px;display:block;"></i>
        <div style="font-family:'Orbitron',sans-serif;font-weight:700;font-size:0.8rem;color:var(--green);">CLOUD SYNC ACTIVE</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="disableFirebaseSync()" style="width:100%;justify-content:center;margin-top:10px;"><i class="fas fa-power-off"></i> Disable</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-database"></i> Local Data</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-green btn-sm" onclick="downloadBackup()"><i class="fas fa-download"></i> Backup</button>
      <button class="btn btn-gold btn-sm" onclick="document.getElementById('restore-input').click()"><i class="fas fa-upload"></i> Restore</button>
      <button class="btn btn-sm" onclick="viewRawData()" style="background:#7c3aed;color:white;"><i class="fas fa-code"></i> Raw JSON</button>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="active" onclick="switchTab('order',this)"><i class="fas fa-utensils"></i><span>Order</span></button>
  <button onclick="switchTab('dashboard',this)"><i class="fas fa-gauge-high"></i><span>Dashboard</span></button>
  <button onclick="switchTab('games',this)"><i class="fas fa-gamepad"></i><span>Games</span></button>
  <button onclick="switchTab('leaderboard',this)"><i class="fas fa-trophy"></i><span>Board</span></button>
  <button onclick="switchTab('data',this)"><i class="fas fa-database"></i><span>Data</span></button>
  <button onclick="switchTab('settings',this)"><i class="fas fa-gear"></i><span>Settings</span></button>
</nav>

<!-- Export Modal -->
<div id="export-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="font-family:'Orbitron',sans-serif;font-weight:800;font-size:0.85rem;color:var(--gold);"><i class="fas fa-file-export"></i> EXPORT</h3>
      <button class="btn btn-sm btn-danger" onclick="document.getElementById('export-modal').style.display='none'"><i class="fas fa-times"></i></button>
    </div>
    <div id="export-content" class="export-area"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn btn-gold btn-sm" onclick="copyExport()"><i class="fas fa-copy"></i> Copy</button>
      <button class="btn btn-green btn-sm" onclick="downloadExport()"><i class="fas fa-download"></i> Download</button>
    </div>
  </div>
</div>

<!-- Edit Game Modal -->
<div id="edit-game-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeEditGameModal()">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="font-family:'Orbitron',sans-serif;font-weight:800;font-size:0.85rem;color:var(--gold);">
        <i class="fas fa-edit"></i> EDIT GAME
      </h3>
      <button class="btn btn-sm btn-danger" onclick="closeEditGameModal()"><i class="fas fa-times"></i></button>
    </div>

    <input id="edit-game-name" class="input" placeholder="Game name..." style="margin-bottom:12px;">
    <textarea id="edit-game-instructions" class="input" placeholder="Game instructions..." style="min-height:200px;resize:vertical;margin-bottom:12px;"></textarea>

    <div style="display:flex;gap:8px;">
      <button class="btn btn-gold" onclick="saveEditedGame()" style="flex:1;justify-content:center;">
        <i class="fas fa-save"></i> Save Changes
      </button>
      <button class="btn btn-danger btn-sm" onclick="closeEditGameModal()" style="flex:1;justify-content:center;">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  </div>
</div>

<!-- Record Results Modal -->
<div id="results-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)closeResultsModal()">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="font-family:'Orbitron',sans-serif;font-weight:800;font-size:0.85rem;color:var(--gold);" id="results-modal-title">
        <i class="fas fa-medal"></i> RECORD RESULTS
      </h3>
      <button class="btn btn-sm btn-danger" onclick="closeResultsModal()"><i class="fas fa-times"></i></button>
    </div>

    <div id="results-form">
    </div>

    <button class="btn btn-gold" onclick="saveGameResults()" style="width:100%;justify-content:center;margin-top:12px;">
      <i class="fas fa-save"></i> Save Results
    </button>
  </div>
</div>

<script>
// ==================== DATA ====================
const DB_KEY = 'rishaan_bday_koenigsegg';
const ADMIN_PIN = '1212';
let pinUnlocked = false;

function defaultData() {
  const kids = [
    {id:'k1',name:'Ayan'},{id:'k2',name:'Kyle'},{id:'k3',name:'Reyansh'},{id:'k4',name:'Brian'},
    {id:'k5',name:'Aveer'},{id:'k6',name:'Arjun'},{id:'k7',name:'Prakriti'},{id:'k8',name:'Avni'},
    {id:'k9',name:'Vivaan'},{id:'k10',name:'Haniel'},{id:'k11',name:'Rainer'},{id:'k12',name:'Viha'}
  ];
  const categories = [{id:'cat1',name:'Starters'},{id:'cat2',name:'Main Course'},{id:'cat3',name:'Beverage'},{id:'cat4',name:'Desserts'}];
  const menuItems = [
    {id:'i1',categoryId:'cat1',name:'Peri Peri French Fries'},{id:'i2',categoryId:'cat1',name:'Loaded Nachos'},{id:'i3',categoryId:'cat1',name:'Cheese Chilli Toast'},
    {id:'i4',categoryId:'cat2',name:'Margherita Pizza'},{id:'i5',categoryId:'cat2',name:'BBQ Chicken Pizza'},{id:'i6',categoryId:'cat2',name:'Chilli Chicken Pizza'},{id:'i7',categoryId:'cat2',name:'Alfredo Veg Pasta'},
    {id:'i8',categoryId:'cat3',name:'Cold Coffee'},{id:'i9',categoryId:'cat3',name:'Iced Tea'},{id:'i10',categoryId:'cat3',name:'Watermelon Juice'},{id:'i11',categoryId:'cat3',name:'Fresh Lime Soda Sweet'},{id:'i12',categoryId:'cat3',name:'Hot Chocolate'},{id:'i13',categoryId:'cat3',name:'Bottled Water'},
    {id:'i14',categoryId:'cat4',name:'Chocolate Ice Cream Cornetto'},{id:'i15',categoryId:'cat4',name:'Birthday Cake'}
  ];
  const orders = {}; kids.forEach(k => orders[k.id] = {});
  const games = [
    {id:'g1', name:'Scavenger Hunt ‚Äì One Object Mission', instructions:'Goal: Find one hidden item. No clues.\n\nHow to Play:\n‚Ä¢ Leader secretly chooses one item inside the party area.\n‚Ä¢ Everyone spreads out and searches.\n‚Ä¢ No asking for hints.\n‚Ä¢ No running outside the allowed space.\n\nRule:\n‚Ä¢ First person to find and bring the item to the Leader wins.\n‚Ä¢ If two grab it at the same time, quick rock-paper-scissors decides.'},
    {id:'g2', name:'Moon Ball', instructions:'What You Need:\n‚Ä¢ 1 soft ball\n‚Ä¢ Music\n\nHow to Play:\n‚Ä¢ Music plays.\n‚Ä¢ Pass the ball fast.\n‚Ä¢ When music stops, whoever has the ball is OUT.\n\nKeep going until one player remains.\n\nWinner becomes Moon Champion.'},
    {id:'g3', name:'Hot Seat Roast', instructions:'How to Play:\n‚Ä¢ Two players sit facing each other.\n‚Ä¢ Player 1 roasts Player 2.\n‚Ä¢ Player 2 can respond with a comeback roast OR accept defeat.\n\nRules:\n‚Ä¢ No mean or personal insults.\n‚Ä¢ Keep it funny.\n‚Ä¢ No bad words.\n\nCrowd cheers for best comeback.'},
    {id:'g4', name:'Most Likely To', instructions:'How to Play:\nLeader says:\n‚Ä¢ Most likely to become a monkey\n‚Ä¢ Most likely to become famous\n‚Ä¢ Most likely to forget homework\n\nEveryone counts 3‚Äì2‚Äì1 and points.\n\nNo arguing. Just laughs.'},
    {id:'g5', name:'Confession or Challenge', instructions:'One player chooses:\n\nCONFESSION\nAnswer honestly.\n\nOR\n\nCHALLENGE\nDo a fun dare.\n\nExamples:\n‚Ä¢ Sing 10 seconds of a song\n‚Ä¢ Do a dramatic walk\n‚Ä¢ Act like a robot\n\nKeep it safe and funny.'},
    {id:'g6', name:'Silent Survival', instructions:'How to Play:\n‚Ä¢ Everyone sits normally.\n‚Ä¢ Leader walks around randomly.\n‚Ä¢ No talking.\n‚Ä¢ No laughing.\n‚Ä¢ No big movements.\n\nIf you laugh or react ‚Üí OUT.\n\nLast silent person wins.'},
    {id:'g7', name:'The Spy (Ongoing Game)', instructions:'Setup:\n‚Ä¢ One person is secretly the Spy.\n‚Ä¢ Only the Spy knows.\n\nMission:\nSpy must stare into someone\'s eyes for 5 seconds.\n\nIf the person does NOT call out "SPY!" in time, they lose.\n\nThis continues randomly during the party.\n\nIf someone correctly calls the Spy ‚Üí Spy loses.'},
    {id:'g8', name:'Reverse Compliment', instructions:'Each player gives someone a compliment that sounds like an insult but is actually positive.\n\nExample:\n"You are surprisingly organized."\n\nFunniest and smartest delivery wins.'},
    {id:'g9', name:'Stare Endurance', instructions:'Setup:\n‚Ä¢ Two players sit facing each other.\n‚Ä¢ Hands visible.\n‚Ä¢ No touching.\n\nRules:\n‚Ä¢ Maintain eye contact.\n‚Ä¢ No smiling.\n‚Ä¢ No laughing.\n‚Ä¢ No exaggerated faces.\n\nFirst to laugh, smile, speak, or look away loses.'},
    {id:'g10', name:'Rap Battle', instructions:'Roles:\n‚Ä¢ 1 Host\n‚Ä¢ 2 Rappers\n‚Ä¢ Judges or crowd voting\n\nHow to Play:\n‚Ä¢ Host announces topic.\n‚Ä¢ Rapper 1 ‚Äì 30 seconds.\n‚Ä¢ Rapper 2 ‚Äì 30 seconds.\n\nNo bad words.\nStay on topic.\nConfidence wins.\n\nWinner stays or moves forward.'},
    {id:'g11', name:'Elimination Roulette', instructions:'Leader asks:\n‚Ä¢ Who thinks they are the funniest?\n‚Ä¢ Who thinks they can beat Rishaan in rap?\n\nAnyone who says YES must step forward.\n\nThey compete instantly.\n\nNo hiding.'},
    {id:'g12', name:'Who Knows Rishaan Best', instructions:'Everyone writes answers secretly.\n\nCorrect Answers:\nFavorite color ‚Äì Green | Favorite food ‚Äì Pizza and pasta | Favorite subject ‚Äì GK | Favorite hobby ‚Äì Raspberry Pi coding and football | Favorite movie ‚Äì Mission Impossible movies | Favorite day ‚Äì Sunday | Favorite hypercar brand ‚Äì Koenigsegg | Bolide or Jesko ‚Äì Jesko Absolut | Space or hypercars ‚Äì Hypercars | Favorite planet ‚Äì Earth | Fiction or science ‚Äì Fiction or impossible science books | Arduino or video games ‚Äì Video games | Robots or rockets ‚Äì Rockets | Favorite book ‚Äì Harry Potter, Percy Jackson, What If, How To | What makes him laugh ‚Äì Friends getting embarrassed | What he does when bored ‚Äì Talks to friends | Really good at ‚Äì Technology, gadgets, AI | Early bird or night owl ‚Äì Night owl | Most excited by ‚Äì New gadget | Favorite gadget ‚Äì Raspberry Pi 5 | Superpower ‚Äì Flying fast | Cooler ‚Äì Superheroes | Most annoying ‚Äì False accusations'}
  ];
  return {kids, categories, menuItems, orders, jointOrders: [], restrictions: {cat1:false, cat2:false, cat3:true, cat4:false}, games, gameResults: []};
}

function loadData() {
  try { const d = JSON.parse(localStorage.getItem(DB_KEY)); if (d) { const def = defaultData(); for (const k in def) if (!(k in d)) d[k] = def[k]; return d; } } catch(e) {}
  const fresh = defaultData(); _saveLocal(fresh); return fresh;
}
function _saveLocal(d) { localStorage.setItem(DB_KEY, JSON.stringify(d)); }
function saveData(d) { _saveLocal(d); if (firebaseSyncEnabled && firebaseDB) firebaseDB.ref('rishaan-birthday').set(d); }

let data = loadData();
let selectedKids = [];

// ==================== UTILS ====================
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function switchTab(name, btn) {
  if ((name === 'settings' || name === 'data') && !pinUnlocked) {
    const pin = prompt('Enter PIN to access ' + name.toUpperCase() + ':');
    if (pin !== ADMIN_PIN) { showToast('INCORRECT PIN!'); return; }
    pinUnlocked = true; showToast('PIN ACCEPTED!');
    setTimeout(() => { pinUnlocked = false; }, 180000);
  }
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'order') renderOrderTab();
  if (name === 'settings') renderSettings();
  if (name === 'games') renderGames();
  if (name === 'leaderboard') renderLeaderboard();
}

function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--gold);color:#000;padding:10px 24px;border-radius:50px;font-family:Orbitron,sans-serif;font-size:0.7rem;font-weight:700;z-index:999;letter-spacing:1px;box-shadow:0 4px 20px rgba(255,215,0,0.3);';
  t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 2000);
}

// ==================== KIDS ====================
function addKid() {
  const input = document.getElementById('kid-name-input'); const name = input.value.trim(); if (!name) return;
  const id = genId(); data.kids.push({id, name}); data.orders[id] = {}; input.value = '';
  saveData(data); renderSettings(); renderOrderTab();
}
function removeKid(id) {
  if (!confirm('Remove this kid and their orders?')) return;
  data.kids = data.kids.filter(k => k.id !== id); delete data.orders[id];
  data.jointOrders = data.jointOrders.filter(j => { j.kidIds = j.kidIds.filter(k => k !== id); return j.kidIds.length > 0; });
  data.gameResults.forEach(result => {
    result.winners = result.winners.filter(w => w.kidId !== id);
  });
  data.gameResults = data.gameResults.filter(r => r.winners.length > 0);
  selectedKids = selectedKids.filter(k => k !== id);
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== CATEGORIES ====================
function addCategory() {
  const input = document.getElementById('cat-name-input'); const name = input.value.trim(); if (!name) return;
  const id = genId(); data.categories.push({id, name}); data.restrictions[id] = false; input.value = '';
  saveData(data); renderSettings(); renderOrderTab();
}
function removeCategory(id) {
  if (!confirm('Remove category and all items?')) return;
  data.categories = data.categories.filter(c => c.id !== id);
  const removed = data.menuItems.filter(m => m.categoryId === id).map(m => m.id);
  data.menuItems = data.menuItems.filter(m => m.categoryId !== id); delete data.restrictions[id];
  for (const kid in data.orders) for (const item of removed) delete data.orders[kid][item];
  data.jointOrders = data.jointOrders.filter(j => !removed.includes(j.itemId));
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== MENU ITEMS ====================
function addMenuItem() {
  const catId = document.getElementById('item-cat-select').value;
  const input = document.getElementById('item-name-input'); const name = input.value.trim();
  if (!catId || !name) { showToast('Select category & enter name'); return; }
  data.menuItems.push({id: genId(), categoryId: catId, name}); input.value = '';
  saveData(data); renderSettings(); renderOrderTab();
}
function removeMenuItem(id) {
  data.menuItems = data.menuItems.filter(m => m.id !== id);
  for (const kid in data.orders) delete data.orders[kid][id];
  data.jointOrders = data.jointOrders.filter(j => j.itemId !== id);
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== GAMES ====================
function addGame() {
  const nameInput = document.getElementById('game-name-input');
  const instructionsInput = document.getElementById('game-instructions-input');
  const name = nameInput.value.trim();

  if (!name) {
    showToast('Enter game name!');
    return;
  }

  const game = {
    id: genId(),
    name: name,
    instructions: instructionsInput.value.trim()
  };

  data.games.push(game);
  nameInput.value = '';
  instructionsInput.value = '';
  saveData(data);
  renderGames();
  showToast('Game added!');
}

function removeGame(gameId) {
  if (!confirm('Remove this game and all its results?')) return;

  data.games = data.games.filter(g => g.id !== gameId);
  data.gameResults = data.gameResults.filter(r => r.gameId !== gameId);
  saveData(data);
  renderGames();
  renderLeaderboard();
  showToast('Game removed!');
}

let editingGameId = null;

function openEditGameModal(gameId) {
  editingGameId = gameId;
  const game = data.games.find(g => g.id === gameId);
  if (!game) return;

  document.getElementById('edit-game-name').value = game.name;
  document.getElementById('edit-game-instructions').value = game.instructions;
  document.getElementById('edit-game-modal').style.display = 'flex';
}

function closeEditGameModal() {
  document.getElementById('edit-game-modal').style.display = 'none';
  editingGameId = null;
  document.getElementById('edit-game-name').value = '';
  document.getElementById('edit-game-instructions').value = '';
}

function saveEditedGame() {
  if (!editingGameId) return;

  const name = document.getElementById('edit-game-name').value.trim();
  const instructions = document.getElementById('edit-game-instructions').value.trim();

  if (!name) {
    showToast('Enter game name!');
    return;
  }

  const game = data.games.find(g => g.id === editingGameId);
  if (game) {
    game.name = name;
    game.instructions = instructions;
    saveData(data);
    renderGames();
    closeEditGameModal();
    showToast('Game updated!');
  }
}

function openResultsModal(gameId) {
  const gameIdx = data.games.findIndex(g => g.id === gameId);
  const game = data.games[gameIdx];
  if (!game) return;

  const gameNum = gameIdx + 1;
  document.getElementById('results-modal-title').innerHTML =
    '<i class="fas fa-medal"></i> GAME ' + gameNum + ': ' + esc(game.name).toUpperCase();

  let html = '<div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:14px;">';
  html += 'Select winners in order. You can mark positions as shared and assign custom points.';
  html += '</div>';

  html += '<div id="winner-slots"></div>';
  html += '<button class="btn btn-gold btn-sm" onclick="addWinnerSlot()" style="margin-top:8px;">';
  html += '<i class="fas fa-plus"></i> Add Winner</button>';

  document.getElementById('results-form').innerHTML = html;
  document.getElementById('results-form').dataset.gameId = gameId;

  resultsFormState = {
    gameId: gameId,
    winners: [
      { position: 1, kidId: '', points: 10, shared: false },
      { position: 2, kidId: '', points: 5, shared: false },
      { position: 3, kidId: '', points: 3, shared: false }
    ]
  };

  renderWinnerSlots();
  document.getElementById('results-modal').style.display = 'flex';
}

function closeResultsModal() {
  document.getElementById('results-modal').style.display = 'none';
  resultsFormState = null;
}

let resultsFormState = null;

function renderWinnerSlots() {
  if (!resultsFormState) return;

  const container = document.getElementById('winner-slots');
  let html = '';

  const positionLabels = ['1st', '2nd', '3rd', '4th', '5th', '6th', '7th', '8th', '9th', '10th'];

  resultsFormState.winners.forEach((winner, idx) => {
    html += '<div class="card" style="padding:12px;margin-bottom:8px;background:var(--bg-elevated);">';

    html += '<div style="font-family:Orbitron,sans-serif;font-size:0.7rem;color:var(--gold);margin-bottom:8px;">';
    html += '<i class="fas fa-medal"></i> ' + (positionLabels[winner.position - 1] || winner.position + 'th') + ' PLACE';
    html += '</div>';

    html += '<select class="select" style="margin-bottom:8px;" onchange="updateWinnerKid(' + idx + ',this.value)">';
    html += '<option value="">-- Select Winner --</option>';
    data.kids.forEach(kid => {
      html += '<option value="' + kid.id + '"' + (winner.kidId === kid.id ? ' selected' : '') + '>';
      html += esc(kid.name) + '</option>';
    });
    html += '</select>';

    html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">';
    html += '<label style="font-size:0.75rem;color:var(--text-muted);flex:1;">Points:</label>';
    html += '<input type="number" class="input" value="' + winner.points + '" min="0" max="100" ';
    html += 'style="width:80px;" onchange="updateWinnerPoints(' + idx + ',this.value)">';
    html += '</div>';

    html += '<div style="display:flex;gap:8px;align-items:center;">';
    html += '<label style="font-size:0.75rem;color:var(--text-muted);flex:1;">Shared position?</label>';
    html += '<input type="checkbox" ' + (winner.shared ? 'checked' : '') + ' ';
    html += 'onchange="updateWinnerShared(' + idx + ',this.checked)" ';
    html += 'style="width:20px;height:20px;cursor:pointer;">';
    html += '</div>';

    if (resultsFormState.winners.length > 1) {
      html += '<button class="btn btn-danger btn-sm" onclick="removeWinnerSlot(' + idx + ')" ';
      html += 'style="width:100%;justify-content:center;margin-top:8px;">';
      html += '<i class="fas fa-times"></i> Remove</button>';
    }

    html += '</div>';
  });

  container.innerHTML = html;
}

function updateWinnerKid(idx, kidId) {
  resultsFormState.winners[idx].kidId = kidId;
}

function updateWinnerPoints(idx, points) {
  resultsFormState.winners[idx].points = parseInt(points) || 0;
}

function updateWinnerShared(idx, shared) {
  resultsFormState.winners[idx].shared = shared;
}

function addWinnerSlot() {
  const nextPosition = resultsFormState.winners.length + 1;
  resultsFormState.winners.push({
    position: nextPosition,
    kidId: '',
    points: Math.max(0, 10 - (nextPosition - 1) * 2),
    shared: false
  });
  renderWinnerSlots();
}

function removeWinnerSlot(idx) {
  resultsFormState.winners.splice(idx, 1);
  resultsFormState.winners.forEach((w, i) => {
    w.position = i + 1;
  });
  renderWinnerSlots();
}

function saveGameResults() {
  if (!resultsFormState) return;

  const validWinners = resultsFormState.winners.filter(w => w.kidId);

  if (validWinners.length === 0) {
    showToast('Select at least one winner!');
    return;
  }

  const result = {
    id: genId(),
    gameId: resultsFormState.gameId,
    timestamp: Date.now(),
    winners: validWinners
  };

  data.gameResults.push(result);
  saveData(data);
  closeResultsModal();
  renderGames();
  renderLeaderboard();
  showToast('Results saved!');
  launchConfetti();
}

// ==================== RESTRICTIONS ====================
function toggleRestriction(catId) {
  data.restrictions[catId] = !data.restrictions[catId];
  if (data.restrictions[catId]) {
    const catItems = data.menuItems.filter(m => m.categoryId === catId).map(m => m.id);
    for (const kidId in data.orders) {
      const ordered = catItems.filter(itemId => data.orders[kidId][itemId] > 0);
      if (ordered.length > 1) for (let i = 1; i < ordered.length; i++) delete data.orders[kidId][ordered[i]];
    }
  }
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== ORDERING ====================
function toggleKidSelection(kidId) {
  const idx = selectedKids.indexOf(kidId);
  if (idx >= 0) selectedKids.splice(idx, 1); else selectedKids.push(kidId);
  renderOrderTab();
}
function getKidItemQty(kidId, itemId) { return (data.orders[kidId] && data.orders[kidId][itemId]) || 0; }
function getJointQty(itemId, kidIds) {
  const key = [...kidIds].sort().join(',');
  const j = data.jointOrders.find(o => o.itemId === itemId && [...o.kidIds].sort().join(',') === key);
  return j ? j.qty : 0;
}
function getCurrentQty(itemId) {
  if (selectedKids.length === 0) return 0;
  if (selectedKids.length === 1) return getKidItemQty(selectedKids[0], itemId);
  return getJointQty(itemId, selectedKids);
}
function isItemDisabledForKid(kidId, itemId, categoryId) {
  if (!data.restrictions[categoryId]) return false;
  const catItems = data.menuItems.filter(m => m.categoryId === categoryId).map(m => m.id);
  if (getKidItemQty(kidId, itemId) > 0) return false;
  for (const ci of catItems) if (ci !== itemId && getKidItemQty(kidId, ci) > 0) return true;
  for (const jo of data.jointOrders) if (jo.kidIds.includes(kidId) && catItems.includes(jo.itemId) && jo.itemId !== itemId && jo.qty > 0) return true;
  return false;
}

function changeQty(itemId, delta) {
  if (selectedKids.length === 0) { alert('Please select a driver first!'); return; }
  if (selectedKids.length === 1) {
    const kidId = selectedKids[0];
    if (!data.orders[kidId]) data.orders[kidId] = {};
    const nq = Math.max(0, (data.orders[kidId][itemId] || 0) + delta);
    if (nq === 0) delete data.orders[kidId][itemId]; else data.orders[kidId][itemId] = nq;
  } else {
    const kidIds = [...selectedKids].sort(); const key = kidIds.join(',');
    let jo = data.jointOrders.find(o => o.itemId === itemId && [...o.kidIds].sort().join(',') === key);
    if (!jo) { jo = {itemId, kidIds:[...kidIds], qty:0}; data.jointOrders.push(jo); }
    jo.qty = Math.max(0, jo.qty + delta);
    if (jo.qty === 0) data.jointOrders = data.jointOrders.filter(o => o !== jo);
  }
  saveData(data); renderOrderTab();
}

function setQty(itemId, value) {
  if (selectedKids.length === 0) return;
  const nq = Math.max(0, Math.min(99, parseInt(value) || 0));
  if (selectedKids.length === 1) {
    const kidId = selectedKids[0]; if (!data.orders[kidId]) data.orders[kidId] = {};
    if (nq === 0) delete data.orders[kidId][itemId]; else data.orders[kidId][itemId] = nq;
  } else {
    const kidIds = [...selectedKids].sort(); const key = kidIds.join(',');
    let jo = data.jointOrders.find(o => o.itemId === itemId && [...o.kidIds].sort().join(',') === key);
    if (nq === 0) { if (jo) data.jointOrders = data.jointOrders.filter(o => o !== jo); }
    else { if (!jo) { jo = {itemId, kidIds:[...kidIds], qty:0}; data.jointOrders.push(jo); } jo.qty = nq; }
  }
  saveData(data); renderOrderTab();
}

function editKidOrder(kidId, itemId, delta) {
  if (!data.orders[kidId]) data.orders[kidId] = {};
  const nq = Math.max(0, (data.orders[kidId][itemId] || 0) + delta);
  if (nq === 0) delete data.orders[kidId][itemId]; else data.orders[kidId][itemId] = nq;
  saveData(data); renderDashboard();
}

// ==================== RENDER: ORDER ====================
function renderOrderTab() {
  const batch = getCurrentBatchItems();
  const batchNum = data.batches.length + 1;
  const batchCard = document.getElementById('batch-status-card');
  batchCard.innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;"><div><div style="font-family:Orbitron,sans-serif;font-weight:700;color:var(--gold);margin-bottom:4px;">CURRENT BATCH #' + batchNum + '</div><div style="font-size:0.8rem;color:var(--text-muted);">' + batch.count + ' items ready</div></div></div><button class="btn btn-gold" onclick="punchOrder()" style="width:100%;justify-content:center;' + (batch.count === 0 ? 'opacity:0.5;pointer-events:none;' : '') + '"><i class="fas fa-flag-checkered"></i> Punch Order</button>';

  const sel = document.getElementById('kid-selector');
  sel.innerHTML = data.kids.length === 0
    ? '<div class="empty-state" style="padding:10px;width:100%"><p>Add drivers in Settings! <i class="fas fa-gear"></i></p></div>'
    : data.kids.map(k => '<div class="kid-chip ' + (selectedKids.includes(k.id) ? 'selected' : '') + '" onclick="toggleKidSelection(\'' + k.id + '\')"><i class="fas fa-' + (selectedKids.includes(k.id) ? 'circle-check' : 'circle') + '" style="font-size:0.65rem"></i> ' + esc(k.name) + '</div>').join('');

  const area = document.getElementById('menu-area');
  if (!data.categories.length || !data.menuItems.length) { area.innerHTML = '<div class="empty-state"><i class="fas fa-gas-pump"></i><p>No menu items yet!<br>Head to Settings.</p></div>'; return; }
  if (!selectedKids.length) { area.innerHTML = '<div class="empty-state" style="padding:50px 20px;"><i class="fas fa-hand-pointer" style="font-size:3.5rem;color:var(--gold);margin-bottom:16px;animation:bounce 1s ease-in-out infinite;"></i><p style="font-size:1.1rem;font-weight:700;color:var(--gold);margin-bottom:8px;">Select a Driver First!</p><p style="color:var(--text-muted);">Tap a driver name above to start ordering</p></div>'; return; }

  const isJoint = selectedKids.length > 1;
  let h = '';
  if (isJoint) {
    const names = selectedKids.map(id => data.kids.find(k => k.id === id)?.name).filter(Boolean);
    h += '<div class="card" style="border-color:rgba(255,71,87,0.2);background:rgba(255,71,87,0.03);"><div style="font-family:Orbitron,sans-serif;font-weight:700;font-size:0.7rem;color:var(--red);letter-spacing:1px;"><i class="fas fa-people-group"></i> TEAM: ' + esc(names.join(' + ')) + '</div></div>';
  }
  for (const cat of data.categories) {
    const items = data.menuItems.filter(m => m.categoryId === cat.id);
    if (!items.length) continue;
    const restricted = data.restrictions[cat.id];
    h += '<div style="margin-bottom:14px;"><div class="category-header"><i class="fas fa-chevron-right" style="font-size:0.55rem"></i> ' + esc(cat.name) + (restricted ? ' <span class="restriction-tag"><i class="fas fa-lock"></i> Pick One</span>' : '') + '</div>';
    for (const item of items) {
      const qty = getCurrentQty(item.id);
      let disabled = !isJoint && restricted && isItemDisabledForKid(selectedKids[0], item.id, cat.id);
      h += '<div class="menu-item' + (disabled ? ' disabled' : '') + (qty > 0 ? ' has-qty' : '') + '">'
        + '<div class="item-name"><span class="qty-badge ' + (qty > 0 ? 'has-qty' : 'no-qty') + '">' + qty + '</span><span class="name-text">' + esc(item.name) + '</span></div>'
        + '<div class="qty-control">'
        + '<button type="button" class="qty-btn minus-btn' + (qty === 0 ? ' dim' : '') + '" onclick="changeQty(\'' + item.id + '\',-1)">&#8722;</button>'
        + '<input type="number" class="qty-input" value="' + qty + '" min="0" max="99" onchange="setQty(\'' + item.id + '\',this.value)" onblur="setQty(\'' + item.id + '\',this.value)" onclick="this.select()">'
        + '<button type="button" class="qty-btn plus-btn" onclick="changeQty(\'' + item.id + '\',1)">+</button>'
        + '</div></div>';
    }
    h += '</div>';
  }
  area.innerHTML = h;
}

// ==================== DRAG & DROP ====================
let draggedCatIndex = null;
let draggedItemId = null;
let draggedItemCatId = null;

function dragStartCat(e) {
  draggedCatIndex = parseInt(e.target.dataset.index);
  e.dataTransfer.effectAllowed = 'move';
  e.target.style.opacity = '0.4';
}

function dragOverCat(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.style.borderColor = 'var(--gold)';
  return false;
}

function dropCat(e) {
  if (e.stopPropagation) e.stopPropagation();
  e.currentTarget.style.borderColor = 'var(--border)';

  const dropIndex = parseInt(e.currentTarget.dataset.index);
  if (draggedCatIndex !== null && draggedCatIndex !== dropIndex) {
    const item = data.categories.splice(draggedCatIndex, 1)[0];
    data.categories.splice(dropIndex, 0, item);
    saveData(data);
    renderSettings();
    renderOrderTab();
  }

  document.querySelectorAll('[draggable]').forEach(el => el.style.opacity = '1');
  draggedCatIndex = null;
  return false;
}

function dragStartItem(e) {
  draggedItemId = e.currentTarget.dataset.itemId;
  draggedItemCatId = e.currentTarget.dataset.catId;
  e.dataTransfer.effectAllowed = 'move';
  e.currentTarget.style.opacity = '0.4';
}

function dragOverItem(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.style.borderColor = 'var(--gold)';
  return false;
}

function dropItem(e) {
  if (e.stopPropagation) e.stopPropagation();
  e.currentTarget.style.borderColor = 'rgba(255,255,255,0.03)';

  const dropItemId = e.currentTarget.dataset.itemId;
  const dropCatId = e.currentTarget.dataset.catId;

  // Only allow reordering within same category
  if (draggedItemId && draggedItemCatId === dropCatId && draggedItemId !== dropItemId) {
    const dragIdx = data.menuItems.findIndex(m => m.id === draggedItemId);
    const dropIdx = data.menuItems.findIndex(m => m.id === dropItemId);

    const item = data.menuItems.splice(dragIdx, 1)[0];
    const newDropIdx = data.menuItems.findIndex(m => m.id === dropItemId);
    data.menuItems.splice(newDropIdx, 0, item);

    saveData(data);
    renderSettings();
    renderOrderTab();
  }

  document.querySelectorAll('[draggable]').forEach(el => el.style.opacity = '1');
  draggedItemId = null;
  draggedItemCatId = null;
  return false;
}

// ==================== RENDER: SETTINGS ====================
function renderSettings() {
  document.getElementById('kids-list').innerHTML = data.kids.length === 0
    ? '<span style="font-size:0.8rem;color:var(--text-subtle)">No drivers yet</span>'
    : data.kids.map(k => '<div class="kid-chip selected" style="cursor:default">' + esc(k.name) + ' <i class="fas fa-times remove" onclick="removeKid(\'' + k.id + '\')"></i></div>').join('');

  document.getElementById('categories-list').innerHTML = data.categories.length === 0
    ? '<span style="font-size:0.8rem;color:var(--text-subtle)">No categories yet</span>'
    : data.categories.map((c, idx) => '<div draggable="true" data-cat-id="' + c.id + '" data-index="' + idx + '" ondragstart="dragStartCat(event)" ondragover="dragOverCat(event)" ondrop="dropCat(event)" style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:10px;margin-bottom:6px;background:var(--bg-elevated);cursor:move;"><div><i class="fas fa-grip-vertical" style="color:var(--text-subtle);margin-right:8px;"></i><span style="font-weight:700;font-size:0.88rem">' + esc(c.name) + '</span> <span class="badge" style="margin-left:6px">' + data.menuItems.filter(m => m.categoryId === c.id).length + '</span>' + (data.restrictions[c.id] ? ' <span class="badge badge-red" style="margin-left:4px">Pick 1</span>' : '') + '</div><button class="btn btn-danger btn-sm" onclick="removeCategory(\'' + c.id + '\')" style="padding:4px 10px"><i class="fas fa-trash" style="font-size:0.65rem"></i></button></div>').join('');

  document.getElementById('item-cat-select').innerHTML = '<option value="">-- Select Category --</option>' + data.categories.map(c => '<option value="' + c.id + '">' + esc(c.name) + '</option>').join('');

  const ml = document.getElementById('menu-items-list');
  if (!data.menuItems.length) { ml.innerHTML = '<span style="font-size:0.8rem;color:var(--text-subtle)">No items yet</span>'; }
  else {
    let h = '';
    for (const cat of data.categories) {
      const items = data.menuItems.filter(m => m.categoryId === cat.id); if (!items.length) continue;
      h += '<div style="font-family:Orbitron,sans-serif;font-size:0.55rem;font-weight:700;color:var(--gold);margin:10px 0 6px;letter-spacing:2px;text-transform:uppercase">' + esc(cat.name) + '</div>';
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        h += '<div draggable="true" data-item-id="' + item.id + '" data-cat-id="' + cat.id + '" data-index="' + i + '" ondragstart="dragStartItem(event)" ondragover="dragOverItem(event)" ondrop="dropItem(event)" style="display:flex;align-items:center;justify-content:space-between;padding:7px 12px;border:1px solid rgba(255,255,255,0.03);border-radius:8px;margin-bottom:3px;cursor:move;"><span style="font-size:0.85rem;font-weight:600"><i class="fas fa-grip-vertical" style="color:var(--text-subtle);margin-right:8px;font-size:0.65rem;"></i>' + esc(item.name) + '</span><button class="btn btn-danger btn-sm" onclick="removeMenuItem(\'' + item.id + '\')" style="padding:3px 8px"><i class="fas fa-times" style="font-size:0.55rem"></i></button></div>';
      }
    }
    ml.innerHTML = h;
  }

  document.getElementById('restrictions-list').innerHTML = data.categories.length === 0
    ? '<span style="font-size:0.8rem;color:var(--text-subtle)">Add categories first</span>'
    : data.categories.map(c => '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.03);"><div><div style="font-weight:700;font-size:0.88rem">' + esc(c.name) + '</div><div style="font-size:0.7rem;color:var(--text-subtle);">Only one item per kid</div></div><button class="toggle ' + (data.restrictions[c.id] ? 'on' : '') + '" onclick="toggleRestriction(\'' + c.id + '\')" style="cursor:pointer;"><div class="knob"></div></button></div>').join('');
}

// ==================== RENDER: DASHBOARD ====================
function renderDashboardBatch(orders, jointOrders, batchIdx) {
  const itemTotals = {}, kidSummaries = {};
  for (const kidId in orders) { if (!kidSummaries[kidId]) kidSummaries[kidId] = []; for (const itemId in orders[kidId]) { const q = orders[kidId][itemId]; if (q > 0) { const it = data.menuItems.find(m => m.id === itemId); if (it) { kidSummaries[kidId].push({itemName:it.name, qty:q, joint:false}); itemTotals[itemId] = (itemTotals[itemId]||0) + q; } } } }
  for (const jo of jointOrders) { if (jo.qty > 0) { const it = data.menuItems.find(m => m.id === jo.itemId); if (it) { const names = jo.kidIds.map(id => data.kids.find(k => k.id === id)?.name).filter(Boolean); for (const kidId of jo.kidIds) { if (!kidSummaries[kidId]) kidSummaries[kidId] = []; const others = names.filter(n => n !== data.kids.find(k => k.id === kidId)?.name); kidSummaries[kidId].push({itemName:it.name, qty:jo.qty, joint:true, sharedWith:others}); } itemTotals[jo.itemId] = (itemTotals[jo.itemId]||0) + jo.qty; } } }
  const totalItems = Object.values(itemTotals).reduce((a,b)=>a+b, 0);
  let h = '';
  if (totalItems === 0) return '';
  const isDraft = batchIdx === -1;
  const batchLabel = isDraft ? 'CURRENT DRAFT' : 'BATCH #' + (batchIdx+1);
  const timestamp = isDraft ? '' : new Date(data.batches[batchIdx].timestamp).toLocaleString();
  h += '<div class="card" style="border-color:rgba(255,215,0,0.2);"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><div><div style="font-family:Orbitron,sans-serif;font-weight:700;color:var(--gold);font-size:0.95rem;">' + batchLabel + '</div>' + (timestamp ? '<div style="font-size:0.75rem;color:var(--text-muted);">üìÖ ' + timestamp + '</div>' : '') + '</div><div style="text-align:right;"><div style="font-size:1.1rem;font-weight:900;color:var(--gold-light);">' + totalItems + ' items</div></div></div>';
  for (const kid of data.kids) { const items = kidSummaries[kid.id]; if (!items?.length) continue; h += '<div style="margin-bottom:12px;"><div class="order-kid-name"><i class="fas fa-user-astronaut"></i> ' + esc(kid.name) + '</div>'; for (const e of items) { const iid = data.menuItems.find(m => m.name === e.itemName)?.id; h += '<div class="order-row"><span style="flex:1;">' + esc(e.itemName) + (e.joint ? '<span class="joint-badge">shared' + (e.sharedWith?.length ? ' w/ ' + e.sharedWith.map(esc).join(', ') : '') + '</span>' : '') + '</span><div style="display:flex;align-items:center;gap:6px;">'; if (!e.joint && iid) h += '<button type="button" class="qty-btn minus-btn" style="width:28px;height:28px;font-size:0.85rem;border-radius:8px;" onclick="editBatchOrder(' + batchIdx + ',\'' + kid.id + '\',\'' + iid + '\',-1)">&#8722;</button><span style="font-weight:800;color:var(--gold-light);min-width:28px;text-align:center;">x' + e.qty + '</span><button type="button" class="qty-btn plus-btn" style="width:28px;height:28px;font-size:0.85rem;border-radius:8px;" onclick="editBatchOrder(' + batchIdx + ',\'' + kid.id + '\',\'' + iid + '\',1)">+</button>'; else h += '<span style="font-weight:800;color:var(--gold-light);">x' + e.qty + '</span>'; h += '</div></div>'; } h += '</div>'; } h += '</div>';
  return h;
}
function renderDashboard() {
  let allH = '';
  const draftH = renderDashboardBatch(data.orders, data.jointOrders, -1);
  if (draftH) allH += draftH;
  for (let i = 0; i < data.batches.length; i++) { const b = data.batches[i]; const bH = renderDashboardBatch(b.orders, b.jointOrders, i); if (bH) allH += bH; }
  if (!allH) allH = '<div class="empty-state" style="padding:20px"><i class="fas fa-flag-checkered"></i><p>No orders yet!</p></div>';
  document.getElementById('dashboard-by-kid').innerHTML = allH;
  document.getElementById('dashboard-summary').innerHTML = '';
  document.getElementById('dashboard-totals').innerHTML = '';
}

// ==================== RENDER: GAMES ====================
function renderGames() {
  const list = document.getElementById('games-list');

  if (data.games.length === 0) {
    list.innerHTML = '<div class="empty-state"><i class="fas fa-gamepad"></i><p>No games yet!<br>Add your first game above.</p></div>';
    return;
  }

  let html = '';

  data.games.forEach((game, idx) => {
    const gameNum = idx + 1;
    const resultsCount = data.gameResults.filter(r => r.gameId === game.id).length;

    html += '<div class="card">';
    html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px;">';
    html += '<div style="flex:1;">';
    html += '<div style="font-family:Orbitron,sans-serif;font-weight:700;font-size:0.95rem;color:var(--gold);">';
    html += '<span style="font-size:0.75rem;color:var(--text-muted);margin-right:6px;">GAME ' + gameNum + ':</span>' + esc(game.name);
    html += '</div>';

    if (game.instructions) {
      html += '<div style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;line-height:1.4;">';
      html += esc(game.instructions);
      html += '</div>';
    }

    html += '</div>';
    html += '<div style="display:flex;gap:6px;">';
    html += '<button class="btn btn-gold btn-sm" onclick="openEditGameModal(\'' + game.id + '\')" style="padding:4px 10px;flex:1;justify-content:center;">';
    html += '<i class="fas fa-edit" style="font-size:0.65rem;"></i> Edit</button>';
    html += '<button class="btn btn-danger btn-sm" onclick="removeGame(\'' + game.id + '\')" style="padding:4px 10px;">';
    html += '<i class="fas fa-trash" style="font-size:0.65rem;"></i></button>';
    html += '</div>';
    html += '</div>';

    html += '<div style="display:flex;gap:8px;margin-bottom:10px;">';
    html += '<span class="badge">' + resultsCount + ' result' + (resultsCount !== 1 ? 's' : '') + '</span>';
    html += '</div>';

    html += '<button class="btn btn-gold btn-sm" onclick="openResultsModal(\'' + game.id + '\')" style="width:100%;justify-content:center;">';
    html += '<i class="fas fa-medal"></i> Record Results</button>';

    const latestResult = data.gameResults
      .filter(r => r.gameId === game.id)
      .sort((a, b) => b.timestamp - a.timestamp)[0];

    if (latestResult) {
      html += '<div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border);">';
      html += '<div style="font-size:0.7rem;color:var(--text-subtle);margin-bottom:6px;">Latest Result:</div>';

      latestResult.winners
        .sort((a, b) => a.position - b.position)
        .slice(0, 3)
        .forEach(w => {
          const kid = data.kids.find(k => k.id === w.kidId);
          if (kid) {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            html += '<div style="font-size:0.8rem;padding:4px 0;">';
            html += '<span style="margin-right:6px;">' + (medals[w.position - 1] || 'üèÖ') + '</span>';
            html += esc(kid.name) + ' <span style="color:var(--gold);">(+' + w.points + ' pts';
            if (w.shared) html += ', shared';
            html += ')</span>';
            html += '</div>';
          }
        });

      html += '</div>';
    }

    html += '</div>';
  });

  list.innerHTML = html;
}

// ==================== RENDER: LEADERBOARD ====================
function renderLeaderboard() {
  renderOverallRankings();
  renderGameBreakdown();
}

function renderOverallRankings() {
  const container = document.getElementById('overall-rankings');

  const kidPoints = {};

  data.kids.forEach(kid => {
    kidPoints[kid.id] = {
      name: kid.name,
      totalPoints: 0,
      gamesWon: 0,
      gamesParticipated: 0
    };
  });

  data.gameResults.forEach(result => {
    result.winners.forEach(winner => {
      if (kidPoints[winner.kidId]) {
        kidPoints[winner.kidId].totalPoints += winner.points;
        kidPoints[winner.kidId].gamesParticipated += 1;
        if (winner.position === 1) {
          kidPoints[winner.kidId].gamesWon += 1;
        }
      }
    });
  });

  const rankings = Object.keys(kidPoints)
    .map(kidId => ({
      kidId: kidId,
      ...kidPoints[kidId]
    }))
    .filter(k => k.totalPoints > 0 || k.gamesParticipated > 0)
    .sort((a, b) => {
      if (b.totalPoints !== a.totalPoints) {
        return b.totalPoints - a.totalPoints;
      }
      return b.gamesWon - a.gamesWon;
    });

  if (rankings.length === 0) {
    container.innerHTML = '<div class="empty-state"><i class="fas fa-trophy"></i><p>No results yet!<br>Record game results to see rankings.</p></div>';
    return;
  }

  let html = '';
  const medals = ['ü•á', 'ü•à', 'ü•â'];

  rankings.forEach((kid, idx) => {
    const position = idx + 1;
    const medal = medals[idx] || 'üèÖ';

    html += '<div class="order-row" style="padding:12px;';
    if (position <= 3) {
      html += 'background:rgba(255,215,0,' + (0.08 - idx * 0.02) + ');';
      html += 'border:1px solid rgba(255,215,0,0.2);border-radius:10px;margin-bottom:6px;';
    }
    html += '">';

    html += '<div style="display:flex;align-items:center;gap:10px;flex:1;">';
    html += '<span style="font-size:1.5rem;">' + medal + '</span>';
    html += '<div>';
    html += '<div style="font-weight:700;font-size:0.95rem;">' + esc(kid.name) + '</div>';
    html += '<div style="font-size:0.7rem;color:var(--text-muted);">';
    html += kid.gamesParticipated + ' game' + (kid.gamesParticipated !== 1 ? 's' : '');
    html += ' ‚Ä¢ ' + kid.gamesWon + ' win' + (kid.gamesWon !== 1 ? 's' : '');
    html += '</div>';
    html += '</div>';
    html += '</div>';

    html += '<div style="font-family:Orbitron,sans-serif;font-weight:900;font-size:1.2rem;color:var(--gold);">';
    html += kid.totalPoints;
    html += '<span style="font-size:0.6rem;font-weight:600;margin-left:2px;">PTS</span>';
    html += '</div>';

    html += '</div>';
  });

  container.innerHTML = html;
}

function renderGameBreakdown() {
  const container = document.getElementById('game-breakdown');

  if (data.gameResults.length === 0) {
    container.innerHTML = '<div class="empty-state" style="padding:20px;"><p>No game results recorded yet.</p></div>';
    return;
  }

  let html = '';

  data.games.forEach((game, idx) => {
    const gameNum = idx + 1;
    const gameResults = data.gameResults
      .filter(r => r.gameId === game.id)
      .sort((a, b) => b.timestamp - a.timestamp);

    if (gameResults.length === 0) return;

    html += '<div style="margin-bottom:20px;">';
    html += '<div style="font-family:Orbitron,sans-serif;font-size:0.7rem;font-weight:700;color:var(--gold);';
    html += 'margin-bottom:8px;letter-spacing:1px;text-transform:uppercase;">';
    html += '<i class="fas fa-gamepad"></i> Game ' + gameNum + ': ' + esc(game.name);
    html += '</div>';

    gameResults.forEach(result => {
      const date = new Date(result.timestamp);
      const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      html += '<div style="background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;';
      html += 'padding:10px;margin-bottom:6px;">';
      html += '<div style="font-size:0.65rem;color:var(--text-subtle);margin-bottom:6px;">' + timeStr + '</div>';

      result.winners
        .sort((a, b) => a.position - b.position)
        .forEach(winner => {
          const kid = data.kids.find(k => k.id === winner.kidId);
          if (!kid) return;

          const medals = ['ü•á', 'ü•à', 'ü•â'];

          html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;">';
          html += '<div>';
          html += '<span style="margin-right:6px;">' + (medals[winner.position - 1] || 'üèÖ') + '</span>';
          html += '<span style="font-weight:600;font-size:0.85rem;">' + esc(kid.name) + '</span>';
          if (winner.shared) {
            html += ' <span class="badge badge-red" style="font-size:0.5rem;padding:1px 5px;">SHARED</span>';
          }
          html += '</div>';
          html += '<span style="font-family:Orbitron,sans-serif;font-weight:700;color:var(--gold);font-size:0.8rem;">';
          html += '+' + winner.points + ' pts</span>';
          html += '</div>';
        });

      html += '</div>';
    });

    html += '</div>';
  });

  container.innerHTML = html;
}

// ==================== BATCHING ====================
function getCurrentBatchItems() {
  const items = {}; const kids = [];
  for (const kid in data.orders) { for (const id in data.orders[kid]) { if (data.orders[kid][id] > 0) { items[id] = (items[id]||0) + data.orders[kid][id]; if (!kids.includes(kid)) kids.push(kid); } } }
  for (const jo of data.jointOrders) { if (jo.qty > 0) { items[jo.itemId] = (items[jo.itemId]||0) + jo.qty; } }
  return {items, count: Object.values(items).reduce((a,b)=>a+b,0), kids};
}
function punchOrder() {
  const batch = getCurrentBatchItems();
  if (batch.count === 0) { showToast('No items to punch!'); return; }
  const batchNum = data.batches.length + 1;
  data.batches.push({id:genId(), timestamp:Date.now(), batchNumber:batchNum, orders:{...data.orders}, jointOrders:[...data.jointOrders]});
  for (const k in data.orders) data.orders[k] = {};
  data.jointOrders = [];
  saveData(data);
  launchConfetti();
  showToast('üèÅ BATCH #' + batchNum + ' PUNCHED!');
  renderOrderTab();
}
function editBatchOrder(batchIdx, kidId, itemId, delta) {
  if (batchIdx === -1) { editKidOrder(kidId, itemId, delta); return; }
  const batch = data.batches[batchIdx];
  if (!batch) return;
  if (!batch.orders[kidId]) batch.orders[kidId] = {};
  const nq = Math.max(0, (batch.orders[kidId][itemId]||0) + delta);
  if (nq === 0) delete batch.orders[kidId][itemId]; else batch.orders[kidId][itemId] = nq;
  saveData(data);
  renderDashboard();
}
function clearAllBatches() { if (!confirm('DELETE all batches? This cannot be undone!')) return; data.batches = []; saveData(data); renderDashboard(); showToast('ALL BATCHES DELETED'); }

// ==================== EXPORT ====================
function exportOrder() {
  const now = new Date().toLocaleString();
  let lines = [
    "=============================================",
    "   RISHAAN'S 10TH BIRTHDAY - FOOD ORDER",
    "   13th February 2026",
    "   Exported: " + now,
    "=============================================",
    "",
    "BATCH SUMMARY:",
    "Total Batches: " + (data.batches.length + (getCurrentBatchItems().count > 0 ? 1 : 0)),
    "Total Items: [Will be calculated]",
    "Total Drivers: " + data.kids.length,
    "=============================================",
    ""
  ];
  let grandTotal = 0;
  function addBatchToExport(orders, jointOrders, batchNum, timestamp) {
    const it = {}; for (const kid in orders) for (const id in orders[kid]) { const q = orders[kid][id]; if (q > 0) it[id] = (it[id]||0) + q; } for (const jo of jointOrders) if (jo.qty > 0) it[jo.itemId] = (it[jo.itemId]||0) + jo.qty;
    if (Object.keys(it).length === 0) return 0;
    lines.push("BATCH #" + batchNum); if (timestamp) lines.push("Punched: " + new Date(timestamp).toLocaleString()); lines.push("---------------------------------------------");
    let bt = 0; for (const cat of data.categories) { const ci = data.menuItems.filter(m => m.categoryId === cat.id && it[m.id]); if (!ci.length) continue; lines.push("[ " + cat.name.toUpperCase() + " ]"); for (const item of ci) { bt += it[item.id]; lines.push("  " + item.name + " ".repeat(Math.max(1, 30-item.name.length)) + "x " + it[item.id]); } }
    lines.push("","INDIVIDUAL ORDERS (Batch #" + batchNum + "):"); for (const kid of data.kids) { const items = []; if (orders[kid.id]) for (const id in orders[kid.id]) { const q = orders[kid.id][id]; if (q > 0) { const m = data.menuItems.find(x => x.id === id); if (m) items.push({name:m.name, qty:q}); } } for (const jo of jointOrders) if (jo.qty > 0 && jo.kidIds.includes(kid.id)) { const m = data.menuItems.find(x => x.id === jo.itemId); if (m) items.push({name:m.name + " (shared)", qty:jo.qty}); } if (!items.length) continue; lines.push("  " + kid.name + ":"); for (const i of items) lines.push("    - " + i.name + "  x" + i.qty); }
    lines.push("","---------------------------------------------"); return bt;
  }
  for (let i = 0; i < data.batches.length; i++) { const b = data.batches[i]; grandTotal += addBatchToExport(b.orders, b.jointOrders, b.batchNumber, b.timestamp); lines.push(""); }
  const draftItems = getCurrentBatchItems().count; if (draftItems > 0) { grandTotal += addBatchToExport(data.orders, data.jointOrders, data.batches.length + 1, null); lines.push(""); }

  // Add detailed summary at the end
  lines.push("=============================================", "DETAILED SUMMARY", "=============================================", "");
  const kidOrderCounts = {};
  for (const kid of data.kids) {
    let count = 0;
    if (data.orders[kid.id]) for (const id in data.orders[kid.id]) count += data.orders[kid.id][id];
    for (const batch of data.batches) if (batch.orders[kid.id]) for (const id in batch.orders[kid.id]) count += batch.orders[kid.id][id];
    if (count > 0) kidOrderCounts[kid.name] = count;
  }
  for (const jo of data.jointOrders) if (jo.qty > 0) { for (const kidId of jo.kidIds) { const kid = data.kids.find(k => k.id === kidId); if (kid) kidOrderCounts[kid.name] = (kidOrderCounts[kid.name] || 0) + jo.qty; } }
  for (const batch of data.batches) for (const jo of batch.jointOrders) if (jo.qty > 0) { for (const kidId of jo.kidIds) { const kid = data.kids.find(k => k.id === kidId); if (kid) kidOrderCounts[kid.name] = (kidOrderCounts[kid.name] || 0) + jo.qty; } }

  lines.push("ITEMS PER DRIVER:");
  for (const kidName in kidOrderCounts) {
    lines.push("  " + kidName + ": " + kidOrderCounts[kidName] + " items");
  }

  lines.push("", "=============================================","GRAND TOTAL: " + grandTotal + " items","=============================================");
  document.getElementById('export-content').textContent = lines.join('\n');
  document.getElementById('export-modal').style.display = 'flex';
}
function copyExport() { navigator.clipboard.writeText(document.getElementById('export-content').textContent).then(() => showToast('COPIED!')); }
function downloadExport() { const b = new Blob([document.getElementById('export-content').textContent],{type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'rishaan_birthday_order.txt'; a.click(); }
function clearAllOrders() { if (!confirm('Clear current draft orders?')) return; for (const k in data.orders) data.orders[k] = {}; data.jointOrders = []; saveData(data); renderOrderTab(); renderDashboard(); showToast('DRAFT CLEARED'); }
function resetApp() { if (!confirm('RESET EVERYTHING?')) return; if (!confirm('Sure?')) return; localStorage.removeItem(DB_KEY); data = defaultData(); selectedKids = []; renderSettings(); renderOrderTab(); showToast('RESET'); }

// ==================== BACKUP ====================
function downloadBackup() { const b = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'rishaan-backup-' + new Date().toISOString().slice(0,10) + '.json'; a.click(); showToast('DOWNLOADED!'); }
function restoreBackup(event) { const f = event.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(e) { try { const d = JSON.parse(e.target.result); if (!d.kids || !d.orders) { showToast('Invalid!'); return; } if (!confirm('Replace data?')) return; data = d; saveData(data); selectedKids = []; renderSettings(); renderOrderTab(); showToast('RESTORED!'); } catch(e) { showToast('Failed!'); } }; r.readAsText(f); event.target.value = ''; }

// ==================== JOKES ====================
const funMessages = [
  "üèéÔ∏è VROOM VROOM! Race mode activated!",
  "üçï Pizza party in the fast lane!",
  "üèÅ Checkered flag vibes only!",
  "‚ö° Turbocharged birthday energy!",
  "üéÇ Rishaan's turning 10 at TOP SPEED!",
  "üî• This party is ON FIRE!",
  "üöÄ Blast off to flavor town!",
  "üí® Burning rubber, eating burgers!",
  "üèÜ Victory lap for the birthday king!",
  "‚≠ê Star driver of the day!",
  "üéâ Party mode: MAXIMUM OVERDRIVE!",
  "üçü French fries fueling the fun!",
  "ü•§ Hydration station pit stop!",
  "üéµ DJ dropping sick beats!",
  "‚ú® Sparkle & shine, it's party time!",
  "üåü Racing into another epic year!",
  "üí´ Drift king in the house!",
  "üéä Confetti cannon ready to EXPLODE!",
  "üîä Turn up the VOLUME!",
  "üé∏ Rock and roll birthday soul!",
  "üåà Rainbow road to awesome!",
  "‚ö° Lightning McQueen got nothing on us!",
  "üèéÔ∏è Koenigsegg level celebration!",
  "üî• Hotter than a Ferrari engine!",
  "üíé Premium fuel, premium fun!",
  "üéØ Bullseye on FUN!",
  "üå™Ô∏è Tornado of excitement!",
  "üé≠ Drama? Nah, just PARTY!",
  "üé™ Circus of delicious food!",
  "üé® Painting the town FAST!",
  "üé¨ Action! Birthday scene take 10!",
  "üì∏ Picture perfect party!",
  "üéÆ Level 10 unlocked!",
  "üèÖ Gold medal celebration!",
  "üëë Crown the birthday champion!",
  "üåä Waves of awesome incoming!",
  "üå∏ Blooming into double digits!",
  "ü¶Ö Soaring to new heights!",
  "üåç World's best party RIGHT HERE!",
  "üéÜ Fireworks of flavor!",
  "üéá Sparklers can't compete!",
  "üå† Shooting star wishes coming true!",
  "‚òÑÔ∏è Meteor shower of fun!",
  "üåô Over the moon excited!",
  "‚òÄÔ∏è Sunshine and good times!",
  "‚ö° Electric atmosphere!",
  "üåÄ Whirlwind of joy!",
  "‚ùÑÔ∏è Too cool for school!",
  "üî• Fire up those engines!",
  "üí• BOOM! Party explosion!",
  "‚ú® Magic in the air!",
  "üéÅ Best gift? This PARTY!",
  "üç∞ Cake o'clock approaching!",
  "üßÅ Cupcake power activate!",
  "üç™ Cookie monster mode ON!",
  "üç© Donut stop believing!",
  "üåÆ Taco 'bout a party!",
  "üåØ Wrap it up, it's party time!",
  "ü•ô Pocket full of awesome!",
  "üçî Burger royalty present!",
  "üçó Finger lickin' good vibes!",
  "ü•ì Bacon makes everything better!",
  "ü•© Steak your claim to fun!",
  "üå≠ Hot dog! What a party!",
  "ü•® Twisted fun ahead!",
  "ü•ê Croissant? More like crois-YAY!",
  "üßÄ Say CHEESE! Party time!",
  "ü•õ Milk those good times!",
  "üç¶ Ice cream dream team!",
  "üçß Shaved ice, maxed fun!",
  "üç® Sundae funday vibes!",
  "üéÇ Let them eat cake!",
  "üç∞ Sweet victory ahead!",
  "üßÅ Muffin compares to this!",
  "üç™ Smart cookie gang!",
  "üç© Hole-y amazing party!",
  "üç´ Chocolate dreams come true!",
  "üç¨ Candy-coated memories!",
  "üç≠ Lollipop good times!",
  "üçÆ Pudding on the ritz!",
  "üçØ Honey, this is SWEET!",
  "üçì Berry good party!",
  "üçá Grape expectations exceeded!",
  "üçâ One in a melon celebration!",
  "üçä Orange you glad you came?",
  "üçã When life gives lemons, PARTY!",
  "üçå Going bananas with fun!",
  "üçç Pineapple of perfection!",
  "ü•• Coconuts about this party!",
  "ü•ù Kiwi-p the party going!",
  "üçë Peachy keen celebration!",
  "üçí Cherry on top vibes!",
  "üçÖ Tomato say you're having fun!",
  "ü•ë Avo great time!",
  "üåΩ Corn-gratulations birthday star!",
  "ü•ï Carrot stop this party!",
  "ü•í Cool as a cucumber!",
  "üå∂Ô∏è Spicing things up!",
  "ü•î Potato quality entertainment!",
  "üçÑ Room to grow and glow!"
];
const kidMessages = [
  " is the SPEED DEMON of this party!",
  " just broke the sound barrier!",
  " is drifting like a PRO!",
  " activated NITROUS BOOST!",
  " crossed the finish line in STYLE!",
  " is the POLE POSITION champion!",
  " just set a new LAP RECORD!",
  " is in the FAST LANE!",
  " shifted to MAXIMUM POWER!",
  " is BURNING RUBBER!",
  " just hit WARP SPEED!",
  " is the DRIFT KING!",
  " went FULL THROTTLE!",
  " achieved LUDICROUS SPEED!",
  " is TURBO CHARGING the party!",
  " just unlocked BEAST MODE!",
  " is ACCELERATING the fun!",
  " took the RACING LINE!",
  " nailed that APEX!",
  " is the TRACK CHAMPION!",
  " just pulled off a PERFECT START!",
  " is DOMINATING the circuit!",
  " entered the SLIPSTREAM!",
  " executed a FLAWLESS overtake!",
  " is the PIT STOP MASTER!",
  " just earned a PODIUM finish!",
  " is REVVING those engines!",
  " hit the SWEET SPOT!",
  " is the SPEED KING!",
  " just went SUPER SONIC!",
  " activated PARTY MODE!",
  " is the CELEBRATION CHAMPION!",
  " brought the HYPE!",
  " is the ENERGY MASTER!",
  " just scored BIG!",
  " is VIBING HARD!",
  " is the FUN LEADER!",
  " brought the THUNDER!",
  " is ROCKING this party!",
  " is the DANCE FLOOR KING!",
  " just did something LEGENDARY!",
  " is UNSTOPPABLE!",
  " is the MVP!",
  " just went NEXT LEVEL!",
  " is CRUSHING IT!",
  " is the PARTY STARTER!",
  " just went SICKO MODE!",
  " is LIVING their BEST LIFE!",
  " is the HYPE TRAIN conductor!",
  " just reached PEAK AWESOME!"
];
let shownMessages = new Set();
let shownKidMessages = new Set();
function showRandomJoke() {
  const b = document.getElementById('joke-banner'), t = document.getElementById('joke-text');

  // Reset if we've shown all messages
  const totalPossible = funMessages.length + (data.kids.length * kidMessages.length);
  if (shownMessages.size + shownKidMessages.size >= totalPossible) {
    shownMessages.clear();
    shownKidMessages.clear();
  }

  if (Math.random() < 0.5 && data.kids.length) {
    // Kid message
    let key, k, msg;
    let attempts = 0;
    do {
      k = data.kids[Math.floor(Math.random() * data.kids.length)];
      msg = kidMessages[Math.floor(Math.random() * kidMessages.length)];
      key = k.name + msg;
      attempts++;
    } while (shownKidMessages.has(key) && attempts < 50);

    shownKidMessages.add(key);
    t.textContent = k.name + msg;
  } else {
    // Fun message
    let idx;
    let attempts = 0;
    do {
      idx = Math.floor(Math.random() * funMessages.length);
      attempts++;
    } while (shownMessages.has(idx) && attempts < 200);

    shownMessages.add(idx);
    t.textContent = funMessages[idx];
  }

  b.style.display = 'block';
  setTimeout(() => { b.style.transform = 'translateY(0)'; }, 10);
  setTimeout(() => {
    b.style.transform = 'translateY(100%)';
    setTimeout(() => { b.style.display = 'none'; }, 400);
  }, 7000);
}
setInterval(showRandomJoke, 10000); setTimeout(showRandomJoke, 2000);


// ==================== BACKGROUND MUSIC ====================
let musicPlaying = false;
let bgMusic, musicIcon;

function toggleMusic() {
  bgMusic = bgMusic || document.getElementById('bg-music');
  musicIcon = musicIcon || document.getElementById('music-icon');

  if (musicPlaying) {
    bgMusic.pause();
    musicIcon.className = 'fas fa-volume-mute';
    musicPlaying = false;
  } else {
    bgMusic.volume = 0.35;
    bgMusic.play().then(() => {
      musicIcon.className = 'fas fa-volume-up';
      musicPlaying = true;
      showToast('üéµ Music Playing!');
    }).catch(err => {
      console.error('Audio error:', err);
      showToast('Click the üîä button to play music!');
      musicIcon.className = 'fas fa-volume-mute';
    });
  }
}

// Auto-play attempt on page load (after short delay)
setTimeout(() => {
  bgMusic = document.getElementById('bg-music');
  musicIcon = document.getElementById('music-icon');
  if (bgMusic) {
    bgMusic.volume = 0.35;
    bgMusic.play().then(() => {
      musicPlaying = true;
      musicIcon.className = 'fas fa-volume-up';
    }).catch(() => {
      // Silently fail - user can manually start
    });
  }
}, 1000);

// ==================== FIREBASE ====================
let firebaseApp = null, firebaseDB = null, firebaseSyncEnabled = false;
function setSyncStatus(c) { const d = document.getElementById('sync-dot'), l = document.getElementById('sync-status').querySelector('div:last-child'); d.style.background = c ? '#10b981' : '#e94560'; d.style.boxShadow = '0 0 6px ' + (c ? '#10b981' : '#e94560'); l.textContent = c ? 'SYNCED' : 'OFFLINE'; l.style.color = c ? '#10b981' : '#e94560'; }
function enableFirebaseSync() {
  const ct = document.getElementById('firebase-config-input').value.trim(); if (!ct) { showToast('Paste config!'); return; }
  try { const cfg = JSON.parse(ct); if (!firebaseApp) { firebaseApp = firebase.initializeApp(cfg); firebaseDB = firebase.database(); } localStorage.setItem('firebase_config', ct);
    firebaseDB.ref('rishaan-birthday').on('value', snap => { const c = snap.val(); if (c) { data = c; _saveLocal(data); const tab = document.querySelector('.tab-content.active').id.replace('tab-',''); if (tab==='order') renderOrderTab(); if (tab==='dashboard') renderDashboard(); if (tab==='settings') renderSettings(); } });
    firebaseSyncEnabled = true; firebaseDB.ref('rishaan-birthday').set(data);
    document.getElementById('firebase-setup').style.display = 'none'; document.getElementById('firebase-active').style.display = 'block'; setSyncStatus(true); showToast('SYNC ON!');
  } catch(e) { showToast('Invalid config!'); }
}
function disableFirebaseSync() { if (!confirm('Disable sync?')) return; if (firebaseDB) firebaseDB.ref('rishaan-birthday').off(); localStorage.removeItem('firebase_config'); firebaseSyncEnabled = false; document.getElementById('firebase-setup').style.display = 'block'; document.getElementById('firebase-active').style.display = 'none'; document.getElementById('firebase-config-input').value = ''; setSyncStatus(false); showToast('Sync off'); }
function viewRawData() { document.getElementById('export-content').textContent = JSON.stringify(data,null,2); document.getElementById('export-modal').style.display = 'flex'; }

// ==================== CONFETTI & CARS ====================
function launchConfetti() { const items = ['üèéÔ∏è','üèÅ','üéÇ','‚≠ê','üéÅ','ü•≥','‚ú®','üèÜ']; for (let i = 0; i < 20; i++) setTimeout(() => { const c = document.createElement('div'); c.className = 'confetti'; c.textContent = items[Math.floor(Math.random()*items.length)]; c.style.left = Math.random()*100+'vw'; c.style.animationDuration = (2+Math.random()*3)+'s'; document.body.appendChild(c); setTimeout(() => c.remove(), 5000); }, i*120); }
function createCar() { const c = document.createElement('div'); c.className = 'koenigsegg-car'; const fwd = Math.random()>0.5; c.textContent = 'üèéÔ∏è'; c.style.fontSize = (Math.random()*1.5+1.5)+'rem'; c.style.bottom = (Math.random()*40+15)+'%'; const spd = Math.random()*2+3; if (fwd) { c.style.left = '-80px'; c.style.animation = 'raceAcross '+spd+'s linear'; } else { c.style.right = '-80px'; c.style.transform = 'scaleX(-1)'; c.style.animation = 'raceReverse '+spd+'s linear'; } document.body.appendChild(c); setTimeout(() => c.remove(), spd*1000+500); }
setInterval(() => { if (Math.random() > 0.6) createCar(); }, 3000);

// ==================== ENTER KEYS ====================
document.getElementById('kid-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addKid(); });
document.getElementById('cat-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addCategory(); });
document.getElementById('item-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addMenuItem(); });
document.getElementById('game-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addGame(); });

// ==================== INIT ====================
renderSettings(); renderOrderTab(); launchConfetti();
setTimeout(() => { const s = localStorage.getItem('firebase_config'); if (s) document.getElementById('firebase-config-input').value = s; }, 500);
</script>
</body>
</html>
