<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rishaan's 10th Birthday - Food Order</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<style>
/* ============================================
   ULTRA PREMIUM DARK THEME
   ============================================ */
:root {
  --bg-primary: #030305;
  --bg-secondary: #08080e;
  --bg-card: #0c0c14;
  --bg-elevated: #101018;
  --gold: #ffd700;
  --gold-dim: #b8860b;
  --gold-light: #ffe55c;
  --red: #ff4757;
  --green: #10b981;
  --purple: #a78bfa;
  --pink: #ec4899;
  --blue: #60a5fa;
  --text: #eaeaf0;
  --text-muted: #6a6a7a;
  --text-subtle: #4a4a5a;
  --border: rgba(255,215,0,0.12);
  --border-bright: rgba(255,215,0,0.3);
  --glow-gold: rgba(255,215,0,0.15);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: transparent;
}

body {
  font-family: 'Rajdhani', sans-serif;
  background: var(--bg-primary);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 80px;
  overflow-x: hidden;
}

/* Subtle vignette */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at 50% 0%, rgba(255,215,0,0.03) 0%, transparent 60%),
              radial-gradient(ellipse at 50% 100%, rgba(0,0,0,0.5) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* ============================================ HEADER */
.header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-bright);
  padding: 14px 20px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 50;
  box-shadow: 0 4px 30px rgba(0,0,0,0.9);
}
.header-logo { display: flex; align-items: center; justify-content: center; gap: 10px; }
.shield { width: 34px; height: 34px; }
.header h1 {
  font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 800;
  background: linear-gradient(135deg, var(--gold), #fff, var(--gold)); background-size: 200% 100%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  letter-spacing: 2px; text-transform: uppercase; animation: shimmer 3s ease-in-out infinite;
}
.header p { font-size: 0.72rem; color: var(--text-muted); letter-spacing: 1px; font-weight: 500; margin-top: 2px; }
.rpm-bar { height: 2px; margin-top: 10px; background: linear-gradient(90deg, transparent, var(--gold), var(--red), var(--gold), transparent); border-radius: 2px; animation: rpmPulse 2s ease-in-out infinite; }

/* ============================================ BOTTOM NAV */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-bright); display: flex; z-index: 50; box-shadow: 0 -4px 30px rgba(0,0,0,0.9); }
.bottom-nav button { flex: 1; padding: 10px 0 8px; border: none; background: none; font-family: 'Rajdhani', sans-serif; font-size: 0.68rem; font-weight: 600; color: var(--text-subtle); display: flex; flex-direction: column; align-items: center; gap: 3px; cursor: pointer; letter-spacing: 1px; text-transform: uppercase; position: relative; transition: color 0.2s; }
.bottom-nav button.active { color: var(--gold); }
.bottom-nav button.active::after { content: ''; position: absolute; top: 0; left: 25%; right: 25%; height: 2px; background: var(--gold); }
.bottom-nav button i { font-size: 1.15rem; }

/* ============================================ TABS */
.tab-content { display: none; padding: 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
.tab-content.active { display: block; }

/* ============================================ CARDS */
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; margin-bottom: 14px; position: relative; overflow: hidden; }
.card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), transparent); }
.card-title { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.85rem; color: var(--gold); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; letter-spacing: 1.5px; text-transform: uppercase; }

/* ============================================ CAR BANNER */
.car-banner { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 14px; margin-bottom: 14px; text-align: center; }
.car-emoji-row { display: flex; justify-content: center; gap: 12px; font-size: 2rem; margin-bottom: 6px; }
.speed-text { font-family: 'Orbitron', sans-serif; font-size: 0.6rem; color: var(--gold); letter-spacing: 3px; text-transform: uppercase; opacity: 0.6; }

/* ============================================ KID CHIPS */
.kid-chip { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 50px; font-size: 1rem; font-weight: 700; cursor: pointer; border: 1px solid rgba(255,255,255,0.08); background: var(--bg-elevated); color: var(--text-muted); margin: 3px; letter-spacing: 0.5px; transition: all 0.15s; user-select: none; -webkit-user-select: none; }
.kid-chip.selected { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #000; border-color: var(--gold); box-shadow: 0 2px 12px rgba(255,215,0,0.3); }
.kid-chip .remove { font-size: 0.65rem; opacity: 0.7; cursor: pointer; }

/* ============================================ MENU ITEMS */
.menu-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.04); border-radius: 12px; margin-bottom: 6px; background: var(--bg-elevated); gap: 8px; }
.menu-item.has-qty { border-color: rgba(255,215,0,0.2); background: rgba(255,215,0,0.03); }
.menu-item.disabled { opacity: 0.2; pointer-events: none; }
.item-name { font-weight: 700; font-size: 1rem; color: var(--text); display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
.item-name .name-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ============================================ QTY BADGE */
.qty-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 32px; height: 32px; border-radius: 50%; font-family: 'Orbitron', sans-serif; font-size: 1rem; font-weight: 900; flex-shrink: 0; border: 2px solid; }
.qty-badge.has-qty { background: linear-gradient(135deg, var(--gold), var(--gold-light)); color: #000; border-color: var(--gold-light); box-shadow: 0 2px 12px rgba(255,215,0,0.4); }
.qty-badge.no-qty { background: var(--bg-secondary); color: var(--text-subtle); border-color: rgba(255,255,255,0.06); }

/* ============================================ QTY CONTROLS */
.qty-control { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.qty-btn {
  width: 44px; height: 44px; border: none; border-radius: 12px;
  font-size: 1.5rem; font-weight: 900; line-height: 1;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  padding: 0; margin: 0; outline: none;
  -webkit-appearance: none; appearance: none;
  user-select: none; -webkit-user-select: none;
  touch-action: manipulation;
  position: relative; z-index: 5;
  transition: transform 0.1s, opacity 0.1s;
}
.qty-btn:active { transform: scale(0.9); }
.qty-btn.minus-btn { background: #dc2626; color: #fff; box-shadow: 0 2px 8px rgba(220,38,38,0.4); }
.qty-btn.plus-btn { background: var(--gold); color: #000; box-shadow: 0 2px 8px rgba(255,215,0,0.4); }
.qty-btn.dim { opacity: 0.25; }

.qty-input { width: 48px; height: 40px; background: #1a1a28; border: 2px solid rgba(255,215,0,0.25); border-radius: 8px; color: var(--gold-light); font-family: 'Orbitron', sans-serif; font-size: 1.1rem; font-weight: 900; text-align: center; outline: none; -moz-appearance: textfield; appearance: textfield; }
.qty-input::-webkit-inner-spin-button, .qty-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
.qty-input:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(255,215,0,0.2); }

/* ============================================ CATEGORY */
.category-header { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.8rem; color: var(--gold); padding: 8px 0; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); margin-bottom: 8px; letter-spacing: 1.5px; text-transform: uppercase; }
.restriction-tag { font-family: 'Rajdhani', sans-serif; font-size: 0.75rem; background: rgba(255,71,87,0.12); color: var(--red); padding: 2px 10px; border-radius: 50px; font-weight: 700; border: 1px solid rgba(255,71,87,0.2); }

/* ============================================ BADGES */
.badge { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #000; font-family: 'Orbitron', sans-serif; font-size: 0.5rem; padding: 2px 8px; border-radius: 50px; font-weight: 700; }
.badge-red { background: linear-gradient(135deg, var(--red), #c53050); color: white; }
.badge-green { background: linear-gradient(135deg, var(--green), #059669); color: white; }
.joint-badge { font-size: 0.6rem; background: var(--red); color: white; padding: 1px 7px; border-radius: 50px; margin-left: 4px; font-weight: 700; }

/* ============================================ BUTTONS */
.btn { padding: 10px 20px; border: none; border-radius: 10px; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; letter-spacing: 0.5px; text-transform: uppercase; transition: opacity 0.15s; }
.btn:active { opacity: 0.8; }
.btn-gold { background: linear-gradient(135deg, var(--gold), var(--gold-dim)); color: #000; }
.btn-red { background: var(--red); color: white; }
.btn-green { background: var(--green); color: white; }
.btn-sm { padding: 6px 14px; font-size: 0.85rem; border-radius: 8px; }
.btn-danger { background: rgba(255,71,87,0.12); color: var(--red); border: 1px solid rgba(255,71,87,0.2); }

/* ============================================ INPUTS */
.input, .select { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px; font-family: 'Rajdhani', sans-serif; font-size: 0.9rem; font-weight: 500; outline: none; background: var(--bg-elevated); color: var(--text); transition: border-color 0.2s; }
.input:focus, .select:focus { border-color: var(--gold); box-shadow: 0 0 0 2px var(--glow-gold); }
.input::placeholder { color: var(--text-subtle); }

/* ============================================ ORDER ROWS */
.order-kid-name { font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.85rem; color: var(--gold); padding: 8px 0; display: flex; align-items: center; gap: 8px; letter-spacing: 1px; }
.order-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; font-size: 0.95rem; border-bottom: 1px solid rgba(255,255,255,0.03); font-weight: 500; }
.summary-row { display: flex; justify-content: space-between; padding: 8px 14px; font-size: 1rem; font-weight: 600; }
.summary-row.total { font-family: 'Orbitron', sans-serif; font-weight: 800; border-top: 2px solid var(--gold); color: var(--gold); margin-top: 6px; padding-top: 12px; font-size: 0.85rem; }

/* ============================================ STAT BOXES */
.stat-box { border-radius: 12px; padding: 14px; text-align: center; border: 1px solid; background: var(--bg-elevated); }
.stat-num { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 900; }
.stat-label { font-size: 0.65rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

/* ============================================ TOGGLE */
.toggle { width: 44px; height: 24px; border-radius: 12px; background: rgba(255,255,255,0.08); position: relative; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: background 0.2s; flex-shrink: 0; }
.toggle.on { background: var(--gold); border-color: var(--gold); }
.toggle .knob { width: 20px; height: 20px; background: #ccc; border-radius: 50%; position: absolute; top: 1px; left: 1px; transition: left 0.2s; }
.toggle.on .knob { left: 21px; background: #111; }

/* ============================================ EMPTY STATE */
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); background: var(--bg-elevated); border-radius: 14px; border: 1px solid var(--border); }
.empty-state i { font-size: 2.5rem; margin-bottom: 12px; display: block; color: rgba(255,215,0,0.3); }
.empty-state p { font-size: 0.85rem; font-weight: 500; }

/* ============================================ EXPORT / MODAL */
.export-area { white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.75rem; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 10px; padding: 14px; max-height: 400px; overflow-y: auto; line-height: 1.6; color: var(--gold-light); }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 60; display: flex; align-items: flex-end; justify-content: center; }
.modal { background: var(--bg-card); border-radius: 20px 20px 0 0; border: 1px solid var(--border-bright); border-bottom: none; padding: 24px; width: 100%; max-width: 600px; max-height: 80vh; overflow-y: auto; animation: slideUp 0.25s ease; }

/* ============================================ HELPERS & ANIMATIONS */
.flex-wrap-gap { display: flex; flex-wrap: wrap; gap: 4px; }

@keyframes shimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
@keyframes rpmPulse { 0%, 100% { opacity: 0.3; transform: scaleX(0.6); } 50% { opacity: 1; transform: scaleX(1); } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
@keyframes bounceIn { 0% { transform: translateX(-50%) scale(0.3); opacity: 0; } 50% { transform: translateX(-50%) scale(1.05); } 100% { transform: translateX(-50%) scale(1); opacity: 1; } }
.confetti { position: fixed; top: -10px; animation: fall linear forwards; pointer-events: none; z-index: 100; font-size: 1.5rem; }
@keyframes fall { to { top: 110vh; transform: rotate(720deg); } }
.koenigsegg-car { position: fixed; z-index: 1; pointer-events: none; }
@keyframes raceAcross { 0% { left: -80px; } 100% { left: 110vw; } }
@keyframes raceReverse { 0% { right: -80px; } 100% { right: 110vw; } }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--gold-dim); border-radius: 4px; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-logo">
    <svg class="shield" viewBox="0 0 80 90" fill="none">
      <path d="M40 5 L70 20 L70 60 Q70 75 40 85 Q10 75 10 60 L10 20Z" stroke="url(#hg)" stroke-width="2.5" fill="rgba(255,215,0,0.06)"/>
      <path d="M40 15 L30 35 L40 30 L50 35Z" fill="url(#hg)"/>
      <path d="M40 30 L25 40 L40 65 L55 40Z" fill="url(#hg)" opacity="0.8"/>
      <path d="M30 18 L35 12 L40 15 L45 12 L50 18" stroke="url(#hg)" stroke-width="1.5" fill="none"/>
      <defs><linearGradient id="hg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#ffd700"/><stop offset="100%" stop-color="#ffe55c"/></linearGradient></defs>
    </svg>
    <div>
      <h1>Rishaan's 10th</h1>
      <p><i class="fas fa-flag-checkered"></i> 13 Feb 2026 &bull; Birthday Pit Stop <i class="fas fa-flag-checkered"></i></p>
    </div>
    <svg class="shield" viewBox="0 0 80 90" fill="none" style="transform:scaleX(-1)">
      <path d="M40 5 L70 20 L70 60 Q70 75 40 85 Q10 75 10 60 L10 20Z" stroke="#ffd700" stroke-width="2.5" fill="rgba(255,215,0,0.06)"/>
      <path d="M40 15 L30 35 L40 30 L50 35Z" fill="#ffd700"/>
      <path d="M40 30 L25 40 L40 65 L55 40Z" fill="#ffd700" opacity="0.8"/>
      <path d="M30 18 L35 12 L40 15 L45 12 L50 18" stroke="#ffd700" stroke-width="1.5" fill="none"/>
    </svg>
  </div>
  <div class="rpm-bar"></div>
</div>

<!-- Joke Banner -->
<div id="joke-banner" style="position:fixed;bottom:85px;left:50%;transform:translateX(-50%);max-width:90%;z-index:100;background:linear-gradient(135deg,var(--purple),var(--pink));border-radius:50px;padding:12px 24px;display:none;box-shadow:0 4px 20px rgba(167,139,250,0.4);animation:bounceIn 0.5s ease;">
  <div style="font-family:'Rajdhani',sans-serif;font-size:0.9rem;font-weight:700;color:white;text-align:center;"><span id="joke-text"></span></div>
</div>

<!-- Sync Status -->
<div id="sync-status" style="position:fixed;top:80px;left:12px;z-index:100;background:var(--bg-card);border:1px solid rgba(16,185,129,0.3);border-radius:50px;padding:6px 14px;display:flex;align-items:center;gap:8px;">
  <div id="sync-dot" style="width:7px;height:7px;border-radius:50%;background:#10b981;box-shadow:0 0 6px #10b981;"></div>
  <div style="font-family:'Orbitron',sans-serif;font-size:0.55rem;color:#10b981;font-weight:700;">SYNCED</div>
</div>

<!-- Background Music Player -->
<button id="music-toggle" onclick="toggleMusic()" style="position:fixed;bottom:20px;right:20px;z-index:100;background:linear-gradient(135deg,var(--gold),var(--gold-dim));border:2px solid var(--gold-light);border-radius:50%;width:60px;height:60px;cursor:pointer;box-shadow:0 8px 32px rgba(255,215,0,0.5);display:flex;align-items:center;justify-content:center;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
  <i id="music-icon" class="fas fa-volume-up" style="font-size:1.5rem;color:#000;"></i>
</button>
<audio id="bg-music" loop preload="auto">
  <source src="https://cdn.freesound.org/previews/625/625671_7037-lq.mp3" type="audio/mpeg">
  <source src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3" type="audio/mpeg">
  <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
</audio>


<!-- TAB: ORDER -->
<div id="tab-order" class="tab-content active">
  <div class="car-banner">
    <div class="car-emoji-row"><span>üèéÔ∏è</span><span>üèÅ</span><span>üèéÔ∏è</span></div>
    <div class="speed-text">Fueling up for an epic celebration</div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-users"></i> Pit Crew - Who's Ordering?</div>
    <div id="kid-selector" class="flex-wrap-gap"></div>
    <div style="margin-top:8px;font-size:0.7rem;color:var(--text-subtle);font-weight:500;"><i class="fas fa-info-circle" style="color:var(--gold);"></i> Select multiple kids for a joint/shared order</div>
  </div>
  <div id="menu-area"></div>
</div>

<!-- TAB: DASHBOARD -->
<div id="tab-dashboard" class="tab-content">
  <div class="card"><div class="card-title"><i class="fas fa-gauge-high"></i> Race Dashboard</div><div id="dashboard-summary"></div></div>
  <div class="card"><div class="card-title"><i class="fas fa-helmet-safety"></i> Orders by Driver</div><div id="dashboard-by-kid"></div></div>
  <div class="card"><div class="card-title"><i class="fas fa-boxes-stacked"></i> Total Quantities</div><div id="dashboard-totals"></div></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
    <button class="btn btn-gold" onclick="exportOrder()"><i class="fas fa-file-export"></i> Export</button>
    <button class="btn btn-danger btn-sm" onclick="clearAllOrders()"><i class="fas fa-trash"></i> Clear All</button>
  </div>
</div>

<!-- TAB: SETTINGS -->
<div id="tab-settings" class="tab-content">
  <div class="card">
    <div class="card-title"><i class="fas fa-helmet-safety"></i> Drivers (Kids)</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;"><input id="kid-name-input" class="input" placeholder="Enter kid's name..."><button class="btn btn-gold btn-sm" onclick="addKid()"><i class="fas fa-plus"></i></button></div>
    <div id="kids-list" class="flex-wrap-gap"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-tags"></i> Categories</div>
    <div style="display:flex;gap:8px;margin-bottom:10px;"><input id="cat-name-input" class="input" placeholder="Category (Pizza, Drinks...)"><button class="btn btn-gold btn-sm" onclick="addCategory()"><i class="fas fa-plus"></i></button></div>
    <div id="categories-list"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-utensils"></i> Menu Items</div>
    <div style="margin-bottom:10px;">
      <select id="item-cat-select" class="select" style="margin-bottom:8px;"><option value="">-- Select Category --</option></select>
      <div style="display:flex;gap:8px;"><input id="item-name-input" class="input" placeholder="Item name..."><button class="btn btn-gold btn-sm" onclick="addMenuItem()"><i class="fas fa-plus"></i></button></div>
    </div>
    <div id="menu-items-list"></div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-sliders"></i> Restrictions</div>
    <p style="font-size:0.75rem;color:var(--text-subtle);margin-bottom:12px;">Enable "Pick Only One" to limit each kid to one item from a category.</p>
    <div id="restrictions-list"></div>
  </div>
  <div class="card" style="border-color:rgba(16,185,129,0.15);">
    <div class="card-title" style="color:var(--green);"><i class="fas fa-shield-halved"></i> Data Backup</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-green btn-sm" onclick="downloadBackup()"><i class="fas fa-download"></i> Download</button>
      <button class="btn btn-gold btn-sm" onclick="document.getElementById('restore-input').click()"><i class="fas fa-upload"></i> Restore</button>
      <input type="file" id="restore-input" accept=".json" style="display:none" onchange="restoreBackup(event)">
    </div>
  </div>
  <div class="card" style="border-color:rgba(255,71,87,0.15);">
    <div class="card-title" style="color:var(--red);"><i class="fas fa-triangle-exclamation"></i> Danger Zone</div>
    <button class="btn btn-danger btn-sm" onclick="resetApp()" style="width:100%;justify-content:center;"><i class="fas fa-bomb"></i> Reset Entire App</button>
  </div>
</div>

<!-- TAB: DATA -->
<div id="tab-data" class="tab-content">
  <div class="card">
    <div class="card-title"><i class="fas fa-cloud"></i> Cloud Sync Setup</div>
    <div id="firebase-setup">
      <div style="background:rgba(255,215,0,0.03);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px;">
        <div style="font-size:0.72rem;font-weight:700;color:var(--gold);margin-bottom:8px;"><i class="fas fa-lightbulb"></i> Quick Setup</div>
        <ol style="font-size:0.72rem;color:var(--text-muted);line-height:1.6;padding-left:20px;">
          <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--gold);text-decoration:underline;">Firebase Console</a></li>
          <li>Create project ‚Üí Realtime Database ‚Üí test mode</li>
          <li>Project Settings ‚Üí Web app ‚Üí Copy config</li>
        </ol>
      </div>
      <label style="font-size:0.72rem;font-weight:600;color:var(--gold);display:block;margin-bottom:6px;">Paste Firebase Config JSON:</label>
      <textarea id="firebase-config-input" class="input" placeholder='{"apiKey":"...","databaseURL":"..."}' style="min-height:100px;font-family:monospace;font-size:0.68rem;resize:vertical;"></textarea>
      <button class="btn btn-gold" onclick="enableFirebaseSync()" style="width:100%;justify-content:center;margin-top:10px;"><i class="fas fa-rocket"></i> Enable Cloud Sync</button>
    </div>
    <div id="firebase-active" style="display:none;">
      <div style="background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:14px;text-align:center;">
        <i class="fas fa-check-circle" style="font-size:2rem;color:var(--green);margin-bottom:8px;display:block;"></i>
        <div style="font-family:'Orbitron',sans-serif;font-weight:700;font-size:0.8rem;color:var(--green);">CLOUD SYNC ACTIVE</div>
      </div>
      <button class="btn btn-danger btn-sm" onclick="disableFirebaseSync()" style="width:100%;justify-content:center;margin-top:10px;"><i class="fas fa-power-off"></i> Disable</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title"><i class="fas fa-database"></i> Local Data</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-green btn-sm" onclick="downloadBackup()"><i class="fas fa-download"></i> Backup</button>
      <button class="btn btn-gold btn-sm" onclick="document.getElementById('restore-input').click()"><i class="fas fa-upload"></i> Restore</button>
      <button class="btn btn-sm" onclick="viewRawData()" style="background:#7c3aed;color:white;"><i class="fas fa-code"></i> Raw JSON</button>
    </div>
  </div>
</div>

<!-- Bottom Nav -->
<nav class="bottom-nav">
  <button class="active" onclick="switchTab('order',this)"><i class="fas fa-utensils"></i><span>Order</span></button>
  <button onclick="switchTab('dashboard',this)"><i class="fas fa-gauge-high"></i><span>Dashboard</span></button>
  <button onclick="switchTab('data',this)"><i class="fas fa-database"></i><span>Data</span></button>
  <button onclick="switchTab('settings',this)"><i class="fas fa-gear"></i><span>Settings</span></button>
</nav>

<!-- Export Modal -->
<div id="export-modal" class="modal-overlay" style="display:none" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="font-family:'Orbitron',sans-serif;font-weight:800;font-size:0.85rem;color:var(--gold);"><i class="fas fa-file-export"></i> EXPORT</h3>
      <button class="btn btn-sm btn-danger" onclick="document.getElementById('export-modal').style.display='none'"><i class="fas fa-times"></i></button>
    </div>
    <div id="export-content" class="export-area"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="btn btn-gold btn-sm" onclick="copyExport()"><i class="fas fa-copy"></i> Copy</button>
      <button class="btn btn-green btn-sm" onclick="downloadExport()"><i class="fas fa-download"></i> Download</button>
    </div>
  </div>
</div>

<script>
// ==================== DATA ====================
const DB_KEY = 'rishaan_bday_koenigsegg';
const ADMIN_PIN = '1212';
let pinUnlocked = false;

function defaultData() {
  const kids = [
    {id:'k1',name:'Ayan'},{id:'k2',name:'Kyle'},{id:'k3',name:'Reyansh'},{id:'k4',name:'Brian'},
    {id:'k5',name:'Aveer'},{id:'k6',name:'Arjun'},{id:'k7',name:'Prakriti'},{id:'k8',name:'Avni'},
    {id:'k9',name:'Vivaan'},{id:'k10',name:'Haniel'},{id:'k11',name:'Rainer'},{id:'k12',name:'Viha'}
  ];
  const categories = [{id:'cat1',name:'Starters'},{id:'cat2',name:'Main Course'},{id:'cat3',name:'Beverage'},{id:'cat4',name:'Desserts'}];
  const menuItems = [
    {id:'i1',categoryId:'cat1',name:'Peri Peri French Fries'},{id:'i2',categoryId:'cat1',name:'Loaded Nachos'},{id:'i3',categoryId:'cat1',name:'Cheese Chilli Toast'},
    {id:'i4',categoryId:'cat2',name:'Margherita Pizza'},{id:'i5',categoryId:'cat2',name:'BBQ Chicken Pizza'},{id:'i6',categoryId:'cat2',name:'Chilli Chicken Pizza'},{id:'i7',categoryId:'cat2',name:'Alfredo Veg Pasta'},
    {id:'i8',categoryId:'cat3',name:'Cold Coffee'},{id:'i9',categoryId:'cat3',name:'Iced Tea'},{id:'i10',categoryId:'cat3',name:'Watermelon Juice'},{id:'i11',categoryId:'cat3',name:'Fresh Lime Soda Sweet'},{id:'i12',categoryId:'cat3',name:'Hot Chocolate'},{id:'i13',categoryId:'cat3',name:'Bottled Water'},
    {id:'i14',categoryId:'cat4',name:'Chocolate Ice Cream Cornetto'},{id:'i15',categoryId:'cat4',name:'Birthday Cake'}
  ];
  const orders = {}; kids.forEach(k => orders[k.id] = {});
  return {kids, categories, menuItems, orders, jointOrders: [], restrictions: {cat1:false, cat2:false, cat3:true, cat4:false}};
}

function loadData() {
  try { const d = JSON.parse(localStorage.getItem(DB_KEY)); if (d) { const def = defaultData(); for (const k in def) if (!(k in d)) d[k] = def[k]; return d; } } catch(e) {}
  const fresh = defaultData(); _saveLocal(fresh); return fresh;
}
function _saveLocal(d) { localStorage.setItem(DB_KEY, JSON.stringify(d)); }
function saveData(d) { _saveLocal(d); if (firebaseSyncEnabled && firebaseDB) firebaseDB.ref('rishaan-birthday').set(d); }

let data = loadData();
let selectedKids = [];

// ==================== UTILS ====================
function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 5); }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function switchTab(name, btn) {
  if ((name === 'settings' || name === 'data') && !pinUnlocked) {
    const pin = prompt('Enter PIN to access ' + name.toUpperCase() + ':');
    if (pin !== ADMIN_PIN) { showToast('INCORRECT PIN!'); return; }
    pinUnlocked = true; showToast('PIN ACCEPTED!');
    setTimeout(() => { pinUnlocked = false; }, 180000);
  }
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.bottom-nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'order') renderOrderTab();
  if (name === 'settings') renderSettings();
}

function showToast(msg) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--gold);color:#000;padding:10px 24px;border-radius:50px;font-family:Orbitron,sans-serif;font-size:0.7rem;font-weight:700;z-index:999;letter-spacing:1px;box-shadow:0 4px 20px rgba(255,215,0,0.3);';
  t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 2000);
}

// ==================== KIDS ====================
function addKid() {
  const input = document.getElementById('kid-name-input'); const name = input.value.trim(); if (!name) return;
  const id = genId(); data.kids.push({id, name}); data.orders[id] = {}; input.value = '';
  saveData(data); renderSettings(); renderOrderTab();
}
function removeKid(id) {
  if (!confirm('Remove this kid and their orders?')) return;
  data.kids = data.kids.filter(k => k.id !== id); delete data.orders[id];
  data.jointOrders = data.jointOrders.filter(j => { j.kidIds = j.kidIds.filter(k => k !== id); return j.kidIds.length > 0; });
  selectedKids = selectedKids.filter(k => k !== id);
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== CATEGORIES ====================
function addCategory() {
  const input = document.getElementById('cat-name-input'); const name = input.value.trim(); if (!name) return;
  const id = genId(); data.categories.push({id, name}); data.restrictions[id] = false; input.value = '';
  saveData(data); renderSettings(); renderOrderTab();
}
function removeCategory(id) {
  if (!confirm('Remove category and all items?')) return;
  data.categories = data.categories.filter(c => c.id !== id);
  const removed = data.menuItems.filter(m => m.categoryId === id).map(m => m.id);
  data.menuItems = data.menuItems.filter(m => m.categoryId !== id); delete data.restrictions[id];
  for (const kid in data.orders) for (const item of removed) delete data.orders[kid][item];
  data.jointOrders = data.jointOrders.filter(j => !removed.includes(j.itemId));
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== MENU ITEMS ====================
function addMenuItem() {
  const catId = document.getElementById('item-cat-select').value;
  const input = document.getElementById('item-name-input'); const name = input.value.trim();
  if (!catId || !name) { showToast('Select category & enter name'); return; }
  data.menuItems.push({id: genId(), categoryId: catId, name}); input.value = '';
  saveData(data); renderSettings(); renderOrderTab();
}
function removeMenuItem(id) {
  data.menuItems = data.menuItems.filter(m => m.id !== id);
  for (const kid in data.orders) delete data.orders[kid][id];
  data.jointOrders = data.jointOrders.filter(j => j.itemId !== id);
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== RESTRICTIONS ====================
function toggleRestriction(catId) {
  data.restrictions[catId] = !data.restrictions[catId];
  if (data.restrictions[catId]) {
    const catItems = data.menuItems.filter(m => m.categoryId === catId).map(m => m.id);
    for (const kidId in data.orders) {
      const ordered = catItems.filter(itemId => data.orders[kidId][itemId] > 0);
      if (ordered.length > 1) for (let i = 1; i < ordered.length; i++) delete data.orders[kidId][ordered[i]];
    }
  }
  saveData(data); renderSettings(); renderOrderTab();
}

// ==================== ORDERING ====================
function toggleKidSelection(kidId) {
  const idx = selectedKids.indexOf(kidId);
  if (idx >= 0) selectedKids.splice(idx, 1); else selectedKids.push(kidId);
  renderOrderTab();
}
function getKidItemQty(kidId, itemId) { return (data.orders[kidId] && data.orders[kidId][itemId]) || 0; }
function getJointQty(itemId, kidIds) {
  const key = [...kidIds].sort().join(',');
  const j = data.jointOrders.find(o => o.itemId === itemId && [...o.kidIds].sort().join(',') === key);
  return j ? j.qty : 0;
}
function getCurrentQty(itemId) {
  if (selectedKids.length === 0) return 0;
  if (selectedKids.length === 1) return getKidItemQty(selectedKids[0], itemId);
  return getJointQty(itemId, selectedKids);
}
function isItemDisabledForKid(kidId, itemId, categoryId) {
  if (!data.restrictions[categoryId]) return false;
  const catItems = data.menuItems.filter(m => m.categoryId === categoryId).map(m => m.id);
  if (getKidItemQty(kidId, itemId) > 0) return false;
  for (const ci of catItems) if (ci !== itemId && getKidItemQty(kidId, ci) > 0) return true;
  for (const jo of data.jointOrders) if (jo.kidIds.includes(kidId) && catItems.includes(jo.itemId) && jo.itemId !== itemId && jo.qty > 0) return true;
  return false;
}

function changeQty(itemId, delta) {
  if (selectedKids.length === 0) { alert('Please select a driver first!'); return; }
  if (selectedKids.length === 1) {
    const kidId = selectedKids[0];
    if (!data.orders[kidId]) data.orders[kidId] = {};
    const nq = Math.max(0, (data.orders[kidId][itemId] || 0) + delta);
    if (nq === 0) delete data.orders[kidId][itemId]; else data.orders[kidId][itemId] = nq;
  } else {
    const kidIds = [...selectedKids].sort(); const key = kidIds.join(',');
    let jo = data.jointOrders.find(o => o.itemId === itemId && [...o.kidIds].sort().join(',') === key);
    if (!jo) { jo = {itemId, kidIds:[...kidIds], qty:0}; data.jointOrders.push(jo); }
    jo.qty = Math.max(0, jo.qty + delta);
    if (jo.qty === 0) data.jointOrders = data.jointOrders.filter(o => o !== jo);
  }
  saveData(data); renderOrderTab();
}

function setQty(itemId, value) {
  if (selectedKids.length === 0) return;
  const nq = Math.max(0, Math.min(99, parseInt(value) || 0));
  if (selectedKids.length === 1) {
    const kidId = selectedKids[0]; if (!data.orders[kidId]) data.orders[kidId] = {};
    if (nq === 0) delete data.orders[kidId][itemId]; else data.orders[kidId][itemId] = nq;
  } else {
    const kidIds = [...selectedKids].sort(); const key = kidIds.join(',');
    let jo = data.jointOrders.find(o => o.itemId === itemId && [...o.kidIds].sort().join(',') === key);
    if (nq === 0) { if (jo) data.jointOrders = data.jointOrders.filter(o => o !== jo); }
    else { if (!jo) { jo = {itemId, kidIds:[...kidIds], qty:0}; data.jointOrders.push(jo); } jo.qty = nq; }
  }
  saveData(data); renderOrderTab();
}

function editKidOrder(kidId, itemId, delta) {
  if (!data.orders[kidId]) data.orders[kidId] = {};
  const nq = Math.max(0, (data.orders[kidId][itemId] || 0) + delta);
  if (nq === 0) delete data.orders[kidId][itemId]; else data.orders[kidId][itemId] = nq;
  saveData(data); renderDashboard();
}

// ==================== RENDER: ORDER ====================
function renderOrderTab() {
  const sel = document.getElementById('kid-selector');
  sel.innerHTML = data.kids.length === 0
    ? '<div class="empty-state" style="padding:10px;width:100%"><p>Add drivers in Settings! <i class="fas fa-gear"></i></p></div>'
    : data.kids.map(k => '<div class="kid-chip ' + (selectedKids.includes(k.id) ? 'selected' : '') + '" onclick="toggleKidSelection(\'' + k.id + '\')"><i class="fas fa-' + (selectedKids.includes(k.id) ? 'circle-check' : 'circle') + '" style="font-size:0.65rem"></i> ' + esc(k.name) + '</div>').join('');

  const area = document.getElementById('menu-area');
  if (!data.categories.length || !data.menuItems.length) { area.innerHTML = '<div class="empty-state"><i class="fas fa-gas-pump"></i><p>No menu items yet!<br>Head to Settings.</p></div>'; return; }
  if (!selectedKids.length) { area.innerHTML = '<div class="empty-state" style="padding:50px 20px;"><i class="fas fa-hand-pointer" style="font-size:3.5rem;color:var(--gold);margin-bottom:16px;animation:bounce 1s ease-in-out infinite;"></i><p style="font-size:1.1rem;font-weight:700;color:var(--gold);margin-bottom:8px;">Select a Driver First!</p><p style="color:var(--text-muted);">Tap a driver name above to start ordering</p></div>'; return; }

  const isJoint = selectedKids.length > 1;
  let h = '';
  if (isJoint) {
    const names = selectedKids.map(id => data.kids.find(k => k.id === id)?.name).filter(Boolean);
    h += '<div class="card" style="border-color:rgba(255,71,87,0.2);background:rgba(255,71,87,0.03);"><div style="font-family:Orbitron,sans-serif;font-weight:700;font-size:0.7rem;color:var(--red);letter-spacing:1px;"><i class="fas fa-people-group"></i> TEAM: ' + esc(names.join(' + ')) + '</div></div>';
  }
  for (const cat of data.categories) {
    const items = data.menuItems.filter(m => m.categoryId === cat.id);
    if (!items.length) continue;
    const restricted = data.restrictions[cat.id];
    h += '<div style="margin-bottom:14px;"><div class="category-header"><i class="fas fa-chevron-right" style="font-size:0.55rem"></i> ' + esc(cat.name) + (restricted ? ' <span class="restriction-tag"><i class="fas fa-lock"></i> Pick One</span>' : '') + '</div>';
    for (const item of items) {
      const qty = getCurrentQty(item.id);
      let disabled = !isJoint && restricted && isItemDisabledForKid(selectedKids[0], item.id, cat.id);
      h += '<div class="menu-item' + (disabled ? ' disabled' : '') + (qty > 0 ? ' has-qty' : '') + '">'
        + '<div class="item-name"><span class="qty-badge ' + (qty > 0 ? 'has-qty' : 'no-qty') + '">' + qty + '</span><span class="name-text">' + esc(item.name) + '</span></div>'
        + '<div class="qty-control">'
        + '<button type="button" class="qty-btn minus-btn' + (qty === 0 ? ' dim' : '') + '" onclick="changeQty(\'' + item.id + '\',-1)">&#8722;</button>'
        + '<input type="number" class="qty-input" value="' + qty + '" min="0" max="99" onchange="setQty(\'' + item.id + '\',this.value)" onblur="setQty(\'' + item.id + '\',this.value)" onclick="this.select()">'
        + '<button type="button" class="qty-btn plus-btn" onclick="changeQty(\'' + item.id + '\',1)">+</button>'
        + '</div></div>';
    }
    h += '</div>';
  }
  area.innerHTML = h;
}

// ==================== DRAG & DROP ====================
let draggedCatIndex = null;
let draggedItemId = null;
let draggedItemCatId = null;

function dragStartCat(e) {
  draggedCatIndex = parseInt(e.target.dataset.index);
  e.dataTransfer.effectAllowed = 'move';
  e.target.style.opacity = '0.4';
}

function dragOverCat(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.style.borderColor = 'var(--gold)';
  return false;
}

function dropCat(e) {
  if (e.stopPropagation) e.stopPropagation();
  e.currentTarget.style.borderColor = 'var(--border)';

  const dropIndex = parseInt(e.currentTarget.dataset.index);
  if (draggedCatIndex !== null && draggedCatIndex !== dropIndex) {
    const item = data.categories.splice(draggedCatIndex, 1)[0];
    data.categories.splice(dropIndex, 0, item);
    saveData(data);
    renderSettings();
    renderOrderTab();
  }

  document.querySelectorAll('[draggable]').forEach(el => el.style.opacity = '1');
  draggedCatIndex = null;
  return false;
}

function dragStartItem(e) {
  draggedItemId = e.currentTarget.dataset.itemId;
  draggedItemCatId = e.currentTarget.dataset.catId;
  e.dataTransfer.effectAllowed = 'move';
  e.currentTarget.style.opacity = '0.4';
}

function dragOverItem(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  e.currentTarget.style.borderColor = 'var(--gold)';
  return false;
}

function dropItem(e) {
  if (e.stopPropagation) e.stopPropagation();
  e.currentTarget.style.borderColor = 'rgba(255,255,255,0.03)';

  const dropItemId = e.currentTarget.dataset.itemId;
  const dropCatId = e.currentTarget.dataset.catId;

  // Only allow reordering within same category
  if (draggedItemId && draggedItemCatId === dropCatId && draggedItemId !== dropItemId) {
    const dragIdx = data.menuItems.findIndex(m => m.id === draggedItemId);
    const dropIdx = data.menuItems.findIndex(m => m.id === dropItemId);

    const item = data.menuItems.splice(dragIdx, 1)[0];
    const newDropIdx = data.menuItems.findIndex(m => m.id === dropItemId);
    data.menuItems.splice(newDropIdx, 0, item);

    saveData(data);
    renderSettings();
    renderOrderTab();
  }

  document.querySelectorAll('[draggable]').forEach(el => el.style.opacity = '1');
  draggedItemId = null;
  draggedItemCatId = null;
  return false;
}

// ==================== RENDER: SETTINGS ====================
function renderSettings() {
  document.getElementById('kids-list').innerHTML = data.kids.length === 0
    ? '<span style="font-size:0.8rem;color:var(--text-subtle)">No drivers yet</span>'
    : data.kids.map(k => '<div class="kid-chip selected" style="cursor:default">' + esc(k.name) + ' <i class="fas fa-times remove" onclick="removeKid(\'' + k.id + '\')"></i></div>').join('');

  document.getElementById('categories-list').innerHTML = data.categories.length === 0
    ? '<span style="font-size:0.8rem;color:var(--text-subtle)">No categories yet</span>'
    : data.categories.map((c, idx) => '<div draggable="true" data-cat-id="' + c.id + '" data-index="' + idx + '" ondragstart="dragStartCat(event)" ondragover="dragOverCat(event)" ondrop="dropCat(event)" style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:10px;margin-bottom:6px;background:var(--bg-elevated);cursor:move;"><div><i class="fas fa-grip-vertical" style="color:var(--text-subtle);margin-right:8px;"></i><span style="font-weight:700;font-size:0.88rem">' + esc(c.name) + '</span> <span class="badge" style="margin-left:6px">' + data.menuItems.filter(m => m.categoryId === c.id).length + '</span>' + (data.restrictions[c.id] ? ' <span class="badge badge-red" style="margin-left:4px">Pick 1</span>' : '') + '</div><button class="btn btn-danger btn-sm" onclick="removeCategory(\'' + c.id + '\')" style="padding:4px 10px"><i class="fas fa-trash" style="font-size:0.65rem"></i></button></div>').join('');

  document.getElementById('item-cat-select').innerHTML = '<option value="">-- Select Category --</option>' + data.categories.map(c => '<option value="' + c.id + '">' + esc(c.name) + '</option>').join('');

  const ml = document.getElementById('menu-items-list');
  if (!data.menuItems.length) { ml.innerHTML = '<span style="font-size:0.8rem;color:var(--text-subtle)">No items yet</span>'; }
  else {
    let h = '';
    for (const cat of data.categories) {
      const items = data.menuItems.filter(m => m.categoryId === cat.id); if (!items.length) continue;
      h += '<div style="font-family:Orbitron,sans-serif;font-size:0.55rem;font-weight:700;color:var(--gold);margin:10px 0 6px;letter-spacing:2px;text-transform:uppercase">' + esc(cat.name) + '</div>';
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        h += '<div draggable="true" data-item-id="' + item.id + '" data-cat-id="' + cat.id + '" data-index="' + i + '" ondragstart="dragStartItem(event)" ondragover="dragOverItem(event)" ondrop="dropItem(event)" style="display:flex;align-items:center;justify-content:space-between;padding:7px 12px;border:1px solid rgba(255,255,255,0.03);border-radius:8px;margin-bottom:3px;cursor:move;"><span style="font-size:0.85rem;font-weight:600"><i class="fas fa-grip-vertical" style="color:var(--text-subtle);margin-right:8px;font-size:0.65rem;"></i>' + esc(item.name) + '</span><button class="btn btn-danger btn-sm" onclick="removeMenuItem(\'' + item.id + '\')" style="padding:3px 8px"><i class="fas fa-times" style="font-size:0.55rem"></i></button></div>';
      }
    }
    ml.innerHTML = h;
  }

  document.getElementById('restrictions-list').innerHTML = data.categories.length === 0
    ? '<span style="font-size:0.8rem;color:var(--text-subtle)">Add categories first</span>'
    : data.categories.map(c => '<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.03);"><div><div style="font-weight:700;font-size:0.88rem">' + esc(c.name) + '</div><div style="font-size:0.7rem;color:var(--text-subtle);">Only one item per kid</div></div><button class="toggle ' + (data.restrictions[c.id] ? 'on' : '') + '" onclick="toggleRestriction(\'' + c.id + '\')" style="cursor:pointer;"><div class="knob"></div></button></div>').join('');
}

// ==================== RENDER: DASHBOARD ====================
function renderDashboard() {
  const itemTotals = {}, kidSummaries = {};
  for (const kidId in data.orders) {
    if (!kidSummaries[kidId]) kidSummaries[kidId] = [];
    for (const itemId in data.orders[kidId]) {
      const q = data.orders[kidId][itemId]; if (q > 0) {
        const it = data.menuItems.find(m => m.id === itemId);
        if (it) { kidSummaries[kidId].push({itemName:it.name, qty:q, joint:false}); itemTotals[itemId] = (itemTotals[itemId]||0) + q; }
      }
    }
  }
  for (const jo of data.jointOrders) {
    if (jo.qty > 0) { const it = data.menuItems.find(m => m.id === jo.itemId); if (it) {
      const names = jo.kidIds.map(id => data.kids.find(k => k.id === id)?.name).filter(Boolean);
      for (const kidId of jo.kidIds) { if (!kidSummaries[kidId]) kidSummaries[kidId] = []; const others = names.filter(n => n !== data.kids.find(k => k.id === kidId)?.name); kidSummaries[kidId].push({itemName:it.name, qty:jo.qty, joint:true, sharedWith:others}); }
      itemTotals[jo.itemId] = (itemTotals[jo.itemId]||0) + jo.qty;
    }}
  }
  const totalItems = Object.values(itemTotals).reduce((a,b)=>a+b, 0);
  const totalKids = data.kids.filter(k => kidSummaries[k.id]?.length > 0).length;
  const totalJoint = data.jointOrders.filter(j => j.qty > 0).length;

  document.getElementById('dashboard-summary').innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;"><div class="stat-box" style="border-color:rgba(255,215,0,0.15);"><div class="stat-num" style="color:var(--gold)">' + totalItems + '</div><div class="stat-label" style="color:var(--gold)">Items</div></div><div class="stat-box" style="border-color:rgba(255,71,87,0.15);"><div class="stat-num" style="color:var(--red)">' + totalKids + '</div><div class="stat-label" style="color:var(--red)">Drivers</div></div><div class="stat-box" style="border-color:rgba(16,185,129,0.15);"><div class="stat-num" style="color:var(--green)">' + totalJoint + '</div><div class="stat-label" style="color:var(--green)">Shared</div></div></div>';

  const byKid = document.getElementById('dashboard-by-kid');
  if (totalKids === 0) { byKid.innerHTML = '<div class="empty-state" style="padding:20px"><i class="fas fa-flag-checkered"></i><p>No orders yet!</p></div>'; }
  else {
    let h = '';
    for (const kid of data.kids) {
      const items = kidSummaries[kid.id]; if (!items?.length) continue;
      h += '<div style="margin-bottom:14px;"><div class="order-kid-name"><i class="fas fa-user-astronaut"></i> ' + esc(kid.name) + '</div>';
      for (const e of items) {
        const iid = data.menuItems.find(m => m.name === e.itemName)?.id;
        h += '<div class="order-row"><span style="flex:1;">' + esc(e.itemName) + (e.joint ? '<span class="joint-badge">shared' + (e.sharedWith?.length ? ' w/ ' + e.sharedWith.map(esc).join(', ') : '') + '</span>' : '') + '</span><div style="display:flex;align-items:center;gap:6px;">';
        if (!e.joint && iid) h += '<button type="button" class="qty-btn minus-btn" style="width:28px;height:28px;font-size:0.85rem;border-radius:8px;" onclick="editKidOrder(\'' + kid.id + '\',\'' + iid + '\',-1)">&#8722;</button><span style="font-weight:800;color:var(--gold-light);min-width:28px;text-align:center;">x' + e.qty + '</span><button type="button" class="qty-btn plus-btn" style="width:28px;height:28px;font-size:0.85rem;border-radius:8px;" onclick="editKidOrder(\'' + kid.id + '\',\'' + iid + '\',1)">+</button>';
        else h += '<span style="font-weight:800;color:var(--gold-light);">x' + e.qty + '</span>';
        h += '</div></div>';
      }
      h += '</div>';
    }
    byKid.innerHTML = h;
  }

  const totDiv = document.getElementById('dashboard-totals');
  if (!Object.keys(itemTotals).length) { totDiv.innerHTML = '<div class="empty-state" style="padding:20px"><p>No items ordered</p></div>'; }
  else {
    let h = '';
    for (const cat of data.categories) { const ci = data.menuItems.filter(m => m.categoryId === cat.id && itemTotals[m.id]); if (!ci.length) continue; h += '<div style="font-family:Orbitron,sans-serif;font-size:0.55rem;font-weight:700;color:var(--gold);margin:10px 0 4px;letter-spacing:2px;text-transform:uppercase">' + esc(cat.name) + '</div>'; for (const it of ci) h += '<div class="summary-row"><span>' + esc(it.name) + '</span><span style="font-weight:800;color:var(--gold-light)">x' + itemTotals[it.id] + '</span></div>'; }
    h += '<div class="summary-row total"><span>TOTAL</span><span>' + totalItems + '</span></div>';
    totDiv.innerHTML = h;
  }
}

// ==================== EXPORT ====================
function exportOrder() {
  const it = {}; for (const kid in data.orders) for (const id in data.orders[kid]) { const q = data.orders[kid][id]; if (q > 0) it[id] = (it[id]||0) + q; }
  for (const jo of data.jointOrders) if (jo.qty > 0) it[jo.itemId] = (it[jo.itemId]||0) + jo.qty;
  let lines = ["=============================================","   RISHAAN'S 10TH BIRTHDAY - FOOD ORDER","   13th February 2026","=============================================","","ORDER LIST:","---------------------------------------------"], gt = 0;
  for (const cat of data.categories) { const ci = data.menuItems.filter(m => m.categoryId === cat.id && it[m.id]); if (!ci.length) continue; lines.push("","[ " + cat.name.toUpperCase() + " ]"); for (const item of ci) { gt += it[item.id]; lines.push("  " + item.name + " ".repeat(Math.max(1, 30-item.name.length)) + "x " + it[item.id]); } }
  lines.push("","---------------------------------------------","  TOTAL: " + gt,"---------------------------------------------","","INDIVIDUAL ORDERS:","---------------------------------------------");
  for (const kid of data.kids) { const items = []; if (data.orders[kid.id]) for (const id in data.orders[kid.id]) { const q = data.orders[kid.id][id]; if (q > 0) { const m = data.menuItems.find(x => x.id === id); if (m) items.push({name:m.name, qty:q}); } } for (const jo of data.jointOrders) if (jo.qty > 0 && jo.kidIds.includes(kid.id)) { const m = data.menuItems.find(x => x.id === jo.itemId); if (m) items.push({name:m.name + " (shared)", qty:jo.qty}); } if (!items.length) continue; lines.push("","  " + kid.name + ":"); for (const i of items) lines.push("    - " + i.name + "  x" + i.qty); }
  lines.push("","=============================================");
  document.getElementById('export-content').textContent = lines.join('\n');
  document.getElementById('export-modal').style.display = 'flex';
}
function copyExport() { navigator.clipboard.writeText(document.getElementById('export-content').textContent).then(() => showToast('COPIED!')); }
function downloadExport() { const b = new Blob([document.getElementById('export-content').textContent],{type:'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'rishaan_birthday_order.txt'; a.click(); }
function clearAllOrders() { if (!confirm('Clear ALL orders?')) return; for (const k in data.orders) data.orders[k] = {}; data.jointOrders = []; saveData(data); renderDashboard(); showToast('CLEARED'); }
function resetApp() { if (!confirm('RESET EVERYTHING?')) return; if (!confirm('Sure?')) return; localStorage.removeItem(DB_KEY); data = defaultData(); selectedKids = []; renderSettings(); renderOrderTab(); showToast('RESET'); }

// ==================== BACKUP ====================
function downloadBackup() { const b = new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'rishaan-backup-' + new Date().toISOString().slice(0,10) + '.json'; a.click(); showToast('DOWNLOADED!'); }
function restoreBackup(event) { const f = event.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = function(e) { try { const d = JSON.parse(e.target.result); if (!d.kids || !d.orders) { showToast('Invalid!'); return; } if (!confirm('Replace data?')) return; data = d; saveData(data); selectedKids = []; renderSettings(); renderOrderTab(); showToast('RESTORED!'); } catch(e) { showToast('Failed!'); } }; r.readAsText(f); event.target.value = ''; }

// ==================== JOKES ====================
const jokes = ["What does a pizza say? Slice to meet you!","Race cars eat fast food!","French fry went to school to be a SMART chip!","Birthday cakes like music they can LAYER on!","Race car won because it never took a BRAKE!","Fake noodle? An im-PASTA!","Sleeping race car? A nap-mobile!","Birthday cake was tier-iffic!","Not your cheese? NACHO cheese!","Balloon's fave music? POP!"];
let lastJ = -1;
function showRandomJoke() {
  const b = document.getElementById('joke-banner'), t = document.getElementById('joke-text');
  let idx; do { idx = Math.floor(Math.random() * jokes.length); } while (idx === lastJ && jokes.length > 1); lastJ = idx;
  if (Math.random() < 0.35 && data.kids.length) { const k = data.kids[Math.floor(Math.random() * data.kids.length)]; t.textContent = k.name + " just broke the speed record for ordering food!"; }
  else t.textContent = jokes[idx];
  b.style.display = 'block'; setTimeout(() => { b.style.display = 'none'; }, 6000);
}
setInterval(showRandomJoke, 8000); setTimeout(showRandomJoke, 3000);


// ==================== BACKGROUND MUSIC ====================
let musicPlaying = false;
let bgMusic, musicIcon;

function toggleMusic() {
  bgMusic = bgMusic || document.getElementById('bg-music');
  musicIcon = musicIcon || document.getElementById('music-icon');

  if (musicPlaying) {
    bgMusic.pause();
    musicIcon.className = 'fas fa-volume-mute';
    musicPlaying = false;
  } else {
    bgMusic.volume = 0.35;
    bgMusic.play().then(() => {
      musicIcon.className = 'fas fa-volume-up';
      musicPlaying = true;
      showToast('üéµ Music Playing!');
    }).catch(err => {
      console.error('Audio error:', err);
      showToast('Click the üîä button to play music!');
      musicIcon.className = 'fas fa-volume-mute';
    });
  }
}

// Auto-play attempt on page load (after short delay)
setTimeout(() => {
  bgMusic = document.getElementById('bg-music');
  musicIcon = document.getElementById('music-icon');
  if (bgMusic) {
    bgMusic.volume = 0.35;
    bgMusic.play().then(() => {
      musicPlaying = true;
      musicIcon.className = 'fas fa-volume-up';
    }).catch(() => {
      // Silently fail - user can manually start
    });
  }
}, 1000);

// ==================== FIREBASE ====================
let firebaseApp = null, firebaseDB = null, firebaseSyncEnabled = false;
function setSyncStatus(c) { const d = document.getElementById('sync-dot'), l = document.getElementById('sync-status').querySelector('div:last-child'); d.style.background = c ? '#10b981' : '#e94560'; d.style.boxShadow = '0 0 6px ' + (c ? '#10b981' : '#e94560'); l.textContent = c ? 'SYNCED' : 'OFFLINE'; l.style.color = c ? '#10b981' : '#e94560'; }
function enableFirebaseSync() {
  const ct = document.getElementById('firebase-config-input').value.trim(); if (!ct) { showToast('Paste config!'); return; }
  try { const cfg = JSON.parse(ct); if (!firebaseApp) { firebaseApp = firebase.initializeApp(cfg); firebaseDB = firebase.database(); } localStorage.setItem('firebase_config', ct);
    firebaseDB.ref('rishaan-birthday').on('value', snap => { const c = snap.val(); if (c) { data = c; _saveLocal(data); const tab = document.querySelector('.tab-content.active').id.replace('tab-',''); if (tab==='order') renderOrderTab(); if (tab==='dashboard') renderDashboard(); if (tab==='settings') renderSettings(); } });
    firebaseSyncEnabled = true; firebaseDB.ref('rishaan-birthday').set(data);
    document.getElementById('firebase-setup').style.display = 'none'; document.getElementById('firebase-active').style.display = 'block'; setSyncStatus(true); showToast('SYNC ON!');
  } catch(e) { showToast('Invalid config!'); }
}
function disableFirebaseSync() { if (!confirm('Disable sync?')) return; if (firebaseDB) firebaseDB.ref('rishaan-birthday').off(); localStorage.removeItem('firebase_config'); firebaseSyncEnabled = false; document.getElementById('firebase-setup').style.display = 'block'; document.getElementById('firebase-active').style.display = 'none'; document.getElementById('firebase-config-input').value = ''; setSyncStatus(false); showToast('Sync off'); }
function viewRawData() { document.getElementById('export-content').textContent = JSON.stringify(data,null,2); document.getElementById('export-modal').style.display = 'flex'; }

// ==================== CONFETTI & CARS ====================
function launchConfetti() { const items = ['üèéÔ∏è','üèÅ','üéÇ','‚≠ê','üéÅ','ü•≥','‚ú®','üèÜ']; for (let i = 0; i < 20; i++) setTimeout(() => { const c = document.createElement('div'); c.className = 'confetti'; c.textContent = items[Math.floor(Math.random()*items.length)]; c.style.left = Math.random()*100+'vw'; c.style.animationDuration = (2+Math.random()*3)+'s'; document.body.appendChild(c); setTimeout(() => c.remove(), 5000); }, i*120); }
function createCar() { const c = document.createElement('div'); c.className = 'koenigsegg-car'; const fwd = Math.random()>0.5; c.textContent = 'üèéÔ∏è'; c.style.fontSize = (Math.random()*1.5+1.5)+'rem'; c.style.bottom = (Math.random()*40+15)+'%'; const spd = Math.random()*2+3; if (fwd) { c.style.left = '-80px'; c.style.animation = 'raceAcross '+spd+'s linear'; } else { c.style.right = '-80px'; c.style.transform = 'scaleX(-1)'; c.style.animation = 'raceReverse '+spd+'s linear'; } document.body.appendChild(c); setTimeout(() => c.remove(), spd*1000+500); }
setInterval(() => { if (Math.random() > 0.6) createCar(); }, 3000);

// ==================== ENTER KEYS ====================
document.getElementById('kid-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addKid(); });
document.getElementById('cat-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addCategory(); });
document.getElementById('item-name-input').addEventListener('keydown', e => { if (e.key === 'Enter') addMenuItem(); });

// ==================== INIT ====================
renderSettings(); renderOrderTab(); launchConfetti();
setTimeout(() => { const s = localStorage.getItem('firebase_config'); if (s) document.getElementById('firebase-config-input').value = s; }, 500);
</script>
</body>
</html>
